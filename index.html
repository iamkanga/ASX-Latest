<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Tracker</title> <!-- Removed ASX from title -->
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <!-- Linking to your separate style.css file -->
    <link rel="stylesheet" href="style.css?v=57"> <!-- Updated CSS version for new styles -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <!-- Hamburger Menu Button - Positioned Left -->
            <button id="hamburgerBtn" class="header-action-btn header-action-btn-left hamburger-btn" aria-label="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1>
            <!-- New "Add Share" button on the main screen - positioned right -->
            <button id="addShareHeaderBtn" class="header-action-btn header-action-btn-right" aria-label="Add new share">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>
    </header>

    <!-- App Sidebar -->
    <aside id="appSidebar" class="app-sidebar">
        <button id="closeMenuBtn" class="close-menu-btn" aria-label="Close menu">&times;</button>
        <h3>My Watchlists</h3>
        <div class="menu-buttons-group">
            <select id="watchlistSelect" class="dropdown-large menu-dropdown" aria-label="Select watchlist"></select>
            <button id="addWatchlistBtn" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-plus-circle"></i> Add New Watchlist</button>
            <button id="editWatchlistBtn" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-edit"></i> Manage Current Watchlist</button>
        </div>
        <h3>Tools</h3>
        <div class="menu-buttons-group">
            <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-plus"></i> Add Share</button>
            <button id="standardCalcBtn" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-calculator"></i> Standard Calculator</button>
            <button id="dividendCalcBtn" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-money-bill-wave"></i> Dividend Calculator</button>
        </div>
        <h3>Theme</h3>
        <div class="menu-buttons-group">
            <button id="themeToggleBtn" class="menu-button-item" data-action-closes-menu="false"><i class="fas fa-palette"></i> Toggle Theme</button>
            <select id="colorThemeSelect" class="dropdown-large menu-dropdown" aria-label="Select color theme">
                <option value="none">No Custom Theme</option>
                <optgroup label="Bold Themes">
                    <option value="bold-1">Ocean</option>
                    <option value="bold-2">Forest</option>
                    <option value="bold-3">Sunset</option>
                    <option value="bold-4">Royal</option>
                    <option value="bold-5">Grape</option>
                    <option value="bold-6">Fire</option>
                    <option value="bold-7">Emerald</option>
                    <option value="bold-8">Plum</option>
                    <option value="bold-9">Aqua</option>
                    <option value="bold-10">Ruby</option>
                </optgroup>
                <optgroup label="Subtle Themes">
                    <option value="subtle-1">Sky</option>
                    <option value="subtle-2">Earth</option>
                    <option value="subtle-3">Rose</option>
                    <option value="subtle-4">Lavender</option>
                    <option value="subtle-5">Mint</option>
                    <option value="subtle-6">Sand</option>
                    <option value="subtle-7">Graphite</option>
                    <option value="subtle-8">Peach</option>
                    <option value="subtle-9">Teal</option>
                    <option value="subtle-10">Stone</option>
                </optgroup>
            </select>
            <button id="revertToDefaultThemeBtn" class="menu-button-item secondary-button" data-action-closes-menu="false">
                <i class="fas fa-undo"></i> Revert to Default
            </button>
        </div>
    </aside>
    <div class="sidebar-overlay"></div> <!-- Overlay to close sidebar on click outside -->

    <main class="container">
        <div id="loadingIndicator" class="loading">Loading...</div>

        <div class="watchlist-controls-row">
            <div class="watchlist-group">
                <label for="watchlistSelect" class="sr-only">Select Watchlist</label>
                <!-- Watchlist select box moved to sidebar and styled as dropdown-large menu-dropdown -->
            </div>
            <div class="sort-group">
                <label for="sortSelect" class="sr-only">Sort By</label>
                <select id="sortSelect" class="dropdown-large" aria-label="Sort shares by">
                    <option value="" disabled selected>Sort</option>
                    <option value="shareName-asc">Code (A-Z)</option>
                    <option value="shareName-desc">Code (Z-A)</option>
                    <option value="currentPrice-asc">Price (Low to High)</option>
                    <option value="currentPrice-desc">Price (High to Low)</option>
                    <option value="targetPrice-asc">Target (Low to High)</option>
                    <option value="targetPrice-desc">Target (High to Low)</option>
                    <option value="dividendAmount-asc">Dividend (Low to High)</option>
                    <option value="dividendAmount-desc">Dividend (High to Low)</option>
                    <option value="frankingCredits-asc">Franking (Low to High)</option>
                    <option value="frankingCredits-desc">Franking (High to Low)</option>
                    <option value="entryDate-desc">Entry Date (Newest First)</option>
                    <option value="entryDate-asc">Entry Date (Oldest First)</option>
                </select>
            </div>
        </div>

        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
            <!-- ASX code buttons will be dynamically added here -->
        </div>

        <section class="share-list-section">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Entered Price</th>
                            <th>Target</th>
                            <th>Dividend & Yields</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be dynamically added here -->
            </div>
        </section>

        <!-- Scroll to Top Button (Mobile Only) -->
        <button id="scrollToTopBtn" aria-label="Scroll to top">
            <i class="fas fa-arrow-up"></i>
        </button>

    </main>

    <!-- Fixed Footer for Auth Button -->
    <footer class="fixed-footer">
        <button id="googleAuthBtn" class="google-auth-btn">
            <i class="fab fa-google"></i> Sign In
        </button>
    </footer>

    <!-- Modals -->

    <!-- Add/Edit Share Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content">
            <button class="close-button" aria-label="Close form">&times;</button>
            <h2 id="formTitle">Add New Share</h2>
            <div class="modal-body-scrollable"> <!-- NEW SCROLLABLE WRAPPER -->
                <label for="shareName">Share Code (ASX):</label>
                <input type="text" id="shareName" placeholder="e.g., CBA" required>

                <label for="currentPrice">Entered Price ($):</label>
                <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 100.00">

                <label for="targetPrice">Target Price ($):</label>
                <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 110.00">

                <label for="dividendAmount">Dividend Amount (per share, $):</label>
                <input type="number" id="dividendAmount" step="0.001" placeholder="e.g., 3.500">

                <label for="frankingCredits">Franking Credits (%):</label>
                <input type="number" id="frankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70.0">

                <h3>Comments</h3>
                <div id="commentsFormContainer">
                    <!-- Dynamic comment sections will be added here by JS -->
                    <!-- One empty section is added by default via JS (clearForm function) -->
                </div>
                <button type="button" id="addCommentSectionBtn" class="add-section-btn">
                    <i class="fas fa-plus"></i> Add Comment
                </button>
            </div> <!-- END modal-body-scrollable -->

            <div class="form-action-buttons">
                <button type="button" id="cancelFormBtn" class="secondary-button"><i class="fas fa-times"></i> Cancel</button>
                <button type="button" id="deleteShareFromFormBtn" class="danger-button" style="display:none;"><i class="fas fa-trash-alt"></i> Delete</button>
                <button type="submit" id="saveShareBtn"><i class="fas fa-save"></i> Save Share</button>
            </div>
        </div>
    </div>

    <!-- Share Detail Modal -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <button class="close-button" aria-label="Close details">&times;</button>
            <h2 id="modalShareName">Share Details</h2>
            <div class="modal-body-scrollable"> <!-- NEW SCROLLABLE WRAPPER -->
                <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span></p>
                <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
                <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
                <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>

                <h3>Comments</h3>
                <div id="modalCommentsContainer">
                    <!-- Comments will be dynamically loaded here -->
                </div>

                <div class="external-links-section">
                    <h3>External Links</h3>
                    <a id="modalMarketIndexLink" class="external-link" href="#" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> View on MarketIndex.com.au</a>
                    <a id="modalFoolLink" class="external-link" href="#" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> View on Fool.com.au</a>
                    <a id="modalCommSecLink" class="external-link" href="#" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> View on CommSec.com.au</a>
                    <p id="commSecLoginMessage" class="ghosted-text commsec-message" style="display:none;">(Requires CommSec login for full details)</p>
                </div>
            </div> <!-- END modal-body-scrollable -->

            <div class="modal-action-buttons">
                <button type="button" id="editShareFromDetailBtn"><i class="fas fa-edit"></i> Edit Share</button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <button class="close-button calc-close-button" aria-label="Close calculator">&times;</button>
            <h2>Dividend Calculator</h2>
            <div class="modal-body-scrollable"> <!-- NEW SCROLLABLE WRAPPER -->
                <div class="calc-input-group">
                    <label for="calcCurrentPrice">Current Share Price ($):</label>
                    <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 100.00">
                </div>
                <div class="calc-input-group">
                    <label for="calcDividendAmount">Dividend Amount (per share, $):</label>
                    <input type="number" id="calcDividendAmount" step="0.001" placeholder="e.g., 3.500">
                </div>
                <div class="calc-input-group">
                    <label for="calcFrankingCredits">Franking Credits (%):</label>
                    <input type="number" id="calcFrankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70.0">
                </div>
                <hr>
                <div class="calc-input-group">
                    <label for="investmentValueSelect">Estimated Investment Value ($):</label>
                    <select id="investmentValueSelect">
                        <option value="1000">1,000</option>
                        <option value="5000">5,000</option>
                        <option value="10000" selected>10,000</option>
                        <option value="25000">25,000</option>
                        <option value="50000">50,000</option>
                        <option value="100000">100,000</option>
                    </select>
                </div>
                <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
                <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">-</span></p>
                <p><strong>Estimated Dividend Income:</strong> <span id="calcEstimatedDividend">-</span></p>
            </div> <!-- END modal-body-scrollable -->
            <div class="modal-action-buttons">
                <button type="button" class="secondary-button" onclick="closeModals()"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content">
            <button class="close-button" aria-label="Close calculator">&times;</button>
            <h2>Calculator</h2>
            <div class="modal-body-scrollable"> <!-- NEW SCROLLABLE WRAPPER -->
                <div class="calculator-display">
                    <div id="calculatorInput" class="calculator-input"></div>
                    <div id="calculatorResult" class="calculator-result">0</div>
                </div>
                <div class="calculator-buttons">
                    <button class="calc-btn clear" data-action="clear">C</button>
                    <button class="calc-btn operator" data-action="percentage">%</button>
                    <button class="calc-btn operator" data-action="divide">√∑</button>
                    <button class="calc-btn" data-value="7">7</button>
                    <button class="calc-btn" data-value="8">8</button>
                    <button class="calc-btn" data-value="9">9</button>
                    <button class="calc-btn operator" data-action="multiply">√ó</button>
                    <button class="calc-btn" data-value="4">4</button>
                    <button class="calc-btn" data-value="5">5</button>
                    <button class="calc-btn" data-value="6">6</button>
                    <button class="calc-btn operator" data-action="subtract">-</button>
                    <button class="calc-btn" data-value="1">1</button>
                    <button class="calc-btn" data-value="2">2</button>
                    <button class="calc-btn" data-value="3">3</button>
                    <button class="calc-btn operator" data-action="add">+</button>
                    <button class="calc-btn zero" data-value="0">0</button>
                    <button class="calc-btn" data-value=".">.</button>
                    <button class="calc-btn equals" data-action="calculate">=</button>
                </div>
            </div> <!-- END modal-body-scrollable -->
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div id="addWatchlistModal" class="modal">
        <div class="modal-content">
            <button class="close-button" aria-label="Close add watchlist">&times;</button>
            <h2>Add New Watchlist</h2>
            <div class="modal-body-scrollable"> <!-- NEW SCROLLABLE WRAPPER -->
                <label for="newWatchlistName">Watchlist Name:</label>
                <input type="text" id="newWatchlistName" placeholder="e.g., My Growth Stocks" required>
            </div> <!-- END modal-body-scrollable -->
            <div class="form-action-buttons">
                <button type="button" id="cancelAddWatchlistBtn" class="secondary-button"><i class="fas fa-times"></i> Cancel</button>
                <button type="submit" id="saveWatchlistBtn"><i class="fas fa-save"></i> Save Watchlist</button>
            </div>
        </div>
    </div>

    <!-- Manage Watchlist Modal (Edit/Delete) -->
    <div id="manageWatchlistModal" class="modal">
        <div class="modal-content">
            <button class="close-button" aria-label="Close manage watchlist">&times;</button>
            <h2>Manage Watchlist</h2>
            <div class="modal-body-scrollable"> <!-- NEW SCROLLABLE WRAPPER -->
                <label for="editWatchlistName">Watchlist Name:</label>
                <input type="text" id="editWatchlistName" required>
            </div> <!-- END modal-body-scrollable -->
            <div class="form-action-buttons">
                <button type="button" id="cancelManageWatchlistBtn" class="secondary-button"><i class="fas fa-times"></i> Cancel</button>
                <button type="button" id="deleteWatchlistInModalBtn" class="danger-button"><i class="fas fa-trash-alt"></i> Delete Watchlist</button>
                <button type="submit" id="saveWatchlistNameBtn"><i class="fas fa-save"></i> Save Name</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal (for Alerts/Confirms) -->
    <div id="customDialogModal" class="modal custom-dialog-modal">
        <div class="modal-content custom-dialog-content">
            <button class="close-button" aria-label="Close dialog">&times;</button>
            <div class="modal-body-scrollable"> <!-- NEW SCROLLABLE WRAPPER -->
                <p id="customDialogMessage"></p>
            </div> <!-- END modal-body-scrollable -->
            <div class="custom-dialog-buttons">
                <button type="button" id="customDialogCancelBtn" class="secondary-button">Cancel</button>
                <button type="button" id="customDialogConfirmBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (already loaded via window.firestoreDb etc.) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, FieldValue, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by the environment)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let firebaseInitialized = false;

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Attempt to sign in with custom token or anonymously
                (async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Firebase: Signed in with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Firebase: Signed in anonymously.");
                        }
                        firebaseInitialized = true;
                    } catch (error) {
                        console.error("Firebase Auth initialization error:", error);
                        document.getElementById('loadingIndicator').innerHTML = `
                            <div class="error-message">
                                <p>Error initializing authentication. Please ensure your Firebase project is set up correctly and security rules allow anonymous or custom token sign-in.</p>
                                <p>Details: ${error.message}</p>
                            </div>
                        `;
                    }
                })();
            } else {
                console.warn("Firebase: No configuration found. Firebase services will not be available.");
                document.getElementById('loadingIndicator').innerHTML = `
                    <div class="error-message">
                        <p>Firebase configuration not found. Please ensure the '__firebase_config' variable is correctly set in your environment.</p>
                        <p>Firebase services (like data storage and authentication) will not be available.</p>
                    </div>
                `;
            }
        } catch (e) {
            console.error("Firebase: Error initializing Firebase App:", e);
            document.getElementById('loadingIndicator').innerHTML = `
                <div class="error-message">
                    <p>Failed to initialize Firebase. This might be due to an incorrect configuration or network issues.</p>
                    <p>Details: ${e.message}</p>
                </div>
            `;
            firebaseInitialized = false;
        }

        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete,
            writeBatch: writeBatch // Exposed writeBatch
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v58) script module loaded and DOMContentLoaded fired."); // Updated version number
        }); 
    </script>
    <!-- Linking to your separate script.js file -->
    <script src="script.js?v=118"></script>
</body>
</html>
