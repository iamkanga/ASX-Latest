<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Watchlist</title>
    <!-- Favicon -->
    <link rel="icon" href="Favicn.png" type="image/png">

    <!-- Linking to your separate style.css file -->
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="./manifest.json">
    <style>
        /* Basic spinner animation for loading overlay */
        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="light-theme">
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <img id="splashKangarooIcon" src="Kangaicon.jpg" alt="Kangaroo Icon" class="pulsing">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">ASX Tracker</h1>
        <button id="splashSignInBtn" class="button primary-button">Google Sign In</button>
        <div id="firebaseInitError" class="error-message" style="display:none;">
            <p>Firebase initialization failed. Please check your internet connection and try again.</p>
            <p>If the issue persists, contact support.</p>
        </div>
    </div>

    <!-- Main Application Content (Initially hidden by splash screen) -->
    <header id="appHeader" class="app-hidden">
        <div class="header-left">
            <button id="hamburgerBtn" class="icon-button"><i class="fas fa-bars"></i></button>
            <h1 id="mainTitle">Share Watchlist</h1>
        </div>
        <div class="header-right">
            <button id="addShareHeaderBtn" class="icon-button primary-icon-button"><i class="fas fa-plus-circle"></i></button>
            <button id="searchStockBtn" class="icon-button"><i class="fas fa-search"></i></button>
            <button id="refreshLivePricesBtn" class="icon-button"><i class="fas fa-sync-alt"></i></button>
            <button id="targetHitIconBtn" class="icon-button target-hit-icon-btn">
                <i class="fas fa-bell"></i>
                <span id="targetHitIconCount" class="alert-count">0</span>
            </button>
        </div>
    </header>

    <main class="container app-hidden">
        <div class="sidebar-overlay"></div>
        <aside id="appSidebar" class="app-sidebar">
            <div class="sidebar-header">
                <h3>Menu</h3>
                <button id="closeMenuBtn" class="icon-button"><i class="fas fa-times"></i></button>
            </div>
            <nav class="sidebar-nav">
                <div class="menu-group">
                    <h4>Watchlists</h4>
                    <button id="addWatchlistBtn" class="menu-button-item"><i class="fas fa-plus-square"></i> <span>Add New Watchlist</span></button>
                    <button id="editWatchlistBtn" class="menu-button-item"><i class="fas fa-edit"></i> <span>Manage Watchlists</span></button>
                    <select id="watchlistSelect" class="menu-select-item"></select>
                </div>
                <div class="menu-group">
                    <h4>Actions</h4>
                    <button id="newShareBtn" class="menu-button-item"><i class="fas fa-plus-circle"></i> <span>Add New Share</span></button>
                    <button id="exportWatchlistBtn" class="menu-button-item"><i class="fas fa-file-export"></i> <span>Export Watchlist to CSV</span></button>
                    <button id="toggleCompactViewBtn" class="menu-button-item"><i class="fas fa-compress-alt"></i> <span>Toggle Compact View</span></button>
                    <div class="menu-toggle-item">
                        <label for="showLastLivePriceToggle">Show Last Price (Closed Market)</label>
                        <input type="checkbox" id="showLastLivePriceToggle" class="toggle-switch">
                    </div>
                </div>
                <div class="menu-group">
                    <h4>Calculators</h4>
                    <button id="standardCalcBtn" class="menu-button-item"><i class="fas fa-calculator"></i> <span>Standard Calculator</span></button>
                    <button id="dividendCalcBtn" class="menu-button-item"><i class="fas fa-hand-holding-usd"></i> <span>Dividend Calculator</span></button>
                </div>
                <div class="menu-group">
                    <h4>Theme</h4>
                    <button id="themeToggleBtn" class="menu-button-item"><i class="fas fa-palette"></i> <span>Cycle Custom Theme</span></button>
                    <select id="colorThemeSelect" class="menu-select-item">
                        <option value="none">No Custom Theme</option>
                        <option value="bold-1">Bold 1</option>
                        <option value="bold-2">Bold 2</option>
                        <option value="bold-3">Bold 3</option>
                        <option value="bold-4">Bold 4</option>
                        <option value="bold-5">Bold 5</option>
                        <option value="bold-6">Bold 6</option>
                        <option value="bold-7">Bold 7</option>
                        <option value="bold-8">Bold 8</option>
                        <option value="bold-9">Bold 9</option>
                        <option value="bold-10">Bold 10</option>
                        <option value="subtle-1">Subtle 1</option>
                        <option value="subtle-2">Subtle 2</option>
                        <option value="subtle-3">Subtle 3</option>
                        <option value="subtle-4">Subtle 4</option>
                        <option value="subtle-5">Subtle 5</option>
                        <option value="subtle-6">Subtle 6</option>
                        <option value="subtle-7">Subtle 7</option>
                        <option value="subtle-8">Subtle 8</option>
                        <option value="subtle-9">Subtle 9</option>
                        <option value="subtle-10">Subtle 10</option>
                        <option value="Muted Blue">Muted Blue</option>
                        <option value="Muted Brown">Muted Brown</option>
                        <option value="Muted Pink">Muted Pink</option>
                        <option value="Muted Green">Muted Green</option>
                        <option value="Muted Purple">Muted Purple</option>
                        <option value="Muted Orange">Muted Orange</option>
                        <option value="Muted Cyan">Muted Cyan</option>
                        <option value="Muted Magenta">Muted Magenta</option>
                        <option value="Muted Gold">Muted Gold</option>
                        <option value="Muted Grey">Muted Grey</option>
                    </select>
                    <button id="revertToDefaultThemeBtn" class="menu-button-item"><i class="fas fa-sync-alt"></i> <span>Toggle Light/Dark</span></button>
                </div>
                <div class="menu-group">
                    <h4>Account</h4>
                    <button id="logoutBtn" class="menu-button-item danger-button"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></button>
                    <button id="deleteAllUserDataBtn" class="menu-button-item danger-button"><i class="fas fa-trash-alt"></i> <span>Delete All My Data</span></button>
                </div>
            </nav>
        </aside>

        <section id="stockWatchlistSection" class="share-list-section">
            <div class="asx-code-buttons-container" id="asxCodeButtonsContainer">
                <!-- ASX code buttons will be dynamically added here -->
            </div>
            <div class="table-container">
                <table id="shareTable" class="share-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Live Price / Change</th>
                            <th>Entered Price</th>
                            <th>Target Price</th>
                            <th>Dividend Yield</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-cards-container">
                <!-- Mobile share cards will be dynamically added here -->
            </div>
        </section>

        <section id="cashAssetsSection" class="cash-assets-section app-hidden">
            <div class="cash-summary">
                <h2>Total Cash & Assets: <span id="totalCashDisplay">$0.00</span></h2>
                <button id="addCashAssetSidebarBtn" class="button primary-button">Add New Cash Asset</button>
            </div>
            <div id="cashCategoriesContainer" class="cash-categories-container">
                <!-- Cash categories will be dynamically added here -->
            </div>
        </section>

        <button id="scrollToTopBtn" class="scroll-to-top-btn"><i class="fas fa-arrow-up"></i></button>
    </main>

    <!-- Share Form Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="formTitle" class="modal-title">Add New Share</h2>
                <button class="form-close-button close-button">&times;</button>
            </div>
            <div class="modal-body-scrollable">
                <div class="form-group">
                    <label for="shareName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ASX Code:</label>
                    <input type="text" id="shareName" placeholder="e.g., CBA" required
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <label for="currentPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Entered Price:</label>
                    <input type="number" step="0.01" id="currentPrice" placeholder="0.00"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <!-- Target Price Alert -->
                <div class="form-group">
                    <label for="targetValueInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Value:</label>
                    <div class="flex space-x-2">
                        <input type="number" step="0.01" id="targetValueInput" placeholder="0.00"
                            class="form-input flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <button type="button" id="targetTypeDollar"
                            class="target-type-btn active bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 dark:bg-blue-700 dark:hover:bg-blue-800">$</button>
                        <button type="button" id="targetTypePercent"
                            class="target-type-btn bg-gray-300 text-gray-800 p-2 rounded-md hover:bg-gray-400 dark:bg-gray-600 dark:text-white dark:hover:bg-gray-700">%</button>
                    </div>
                    <p id="targetCalculationDisplay" class="text-sm text-gray-500 mt-1 dark:text-gray-400 mb-4"></p>
                </div>
                <div class="form-group">
                    <label for="dividendAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dividend Amount per Share (Annual):</label>
                    <input type="number" step="0.001" id="dividendAmount" placeholder="0.000"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <label for="frankingCredits" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Franking Credits (%):</label>
                    <input type="number" step="0.1" id="frankingCredits" placeholder="0.0" value="0"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <label for="shareRating" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Star Rating:</label>
                    <select id="shareRating"
                        class="form-select mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="0">No Rating</option>
                        <option value="1">⭐</option>
                        <option value="2">⭐⭐</option>
                        <option value="3">⭐⭐⭐</option>
                        <option value="4">⭐⭐⭐⭐</option>
                        <option value="5">⭐⭐⭐⭐⭐</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shareWatchlistSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Assign to Watchlist:</label>
                    <select id="shareWatchlistSelect"
                        class="form-select mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <!-- Options will be dynamically populated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <div id="dynamicCommentsArea">
                        <!-- Dynamic comment sections will be added here -->
                    </div>
                    <button type="button" id="addCommentSectionBtn" class="button secondary-button mt-4">Add Comment Section</button>
                </div>
            </div>
            <div class="modal-action-buttons">
                <button id="saveShareBtn" class="button primary-button">Save Share</button>
                <button id="deleteShareBtn" class="button danger-button hidden">Delete Share</button>
            </div>
        </div>
    </div>

    <!-- Share Detail Modal -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalShareName" class="modal-title"></h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body-scrollable">
                <div class="live-price-display-section">
                    <!-- Live price, change, P/E, 52-week high/low will be dynamically inserted here -->
                </div>
                <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span></p>
                <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
                <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
                <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>
                <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                <p><strong>Star Rating:</strong> <span id="modalStarRating"></span></p>
                <div class="comments-display-section">
                    <h3>Comments:</h3>
                    <div id="modalCommentsContainer">
                        <!-- Comments will be dynamically added here -->
                    </div>
                </div>
                <div class="external-links-section">
                    <h3>External Links</h3>
                    <div class="external-link-item">
                        <a id="modalNewsLink" href="#" target="_blank" class="external-link">View News <i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <div class="external-link-item">
                        <a id="modalMarketIndexLink" href="#" target="_blank" class="external-link">View on MarketIndex.com.au <i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <div class="external-link-item">
                        <a id="modalFoolLink" href="#" target="_blank" class="external-link">View on Fool.com.au <i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <div class="external-link-item">
                        <a id="modalCommSecLink" href="#" target="_blank" class="external-link">View on CommSec.com.au <i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <p class="ghosted-text commsec-message" id="commSecLoginMessage">Requires single CommSec login per session</p>
                </div>
            </div>
            <div class="modal-action-buttons">
                <button id="editShareFromDetailBtn" class="button secondary-button">Edit Share</button>
                <button id="deleteShareFromDetailBtn" class="button danger-button">Delete Share</button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Dividend Calculator</h2>
                <button class="calc-close-button close-button">&times;</button>
            </div>
            <div class="modal-body-scrollable">
                <div class="form-group">
                    <label for="calcCurrentPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Price per Share:</label>
                    <input type="number" step="0.01" id="calcCurrentPrice" placeholder="0.00"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <label for="calcDividendAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dividend Amount per Share (Annual):</label>
                    <input type="number" step="0.001" id="calcDividendAmount" placeholder="0.000"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <label for="calcFrankingCredits" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Franking Credits (%):</label>
                    <input type="number" step="0.1" id="calcFrankingCredits" placeholder="0.0" value="0"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
                    <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">-</span></p>
                </div>
                <div class="form-group">
                    <label for="investmentValueSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Estimate Dividend Income for Investment Value:</label>
                    <select id="investmentValueSelect"
                        class="form-select mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="1000">AUD 1,000</option>
                        <option value="5000">AUD 5,000</option>
                        <option value="10000" selected>AUD 10,000</option>
                        <option value="20000">AUD 20,000</option>
                        <option value="50000">AUD 50,000</option>
                        <option value="100000">AUD 100,000</option>
                    </select>
                    <p class="mt-2"><strong>Estimated Annual Dividend:</strong> <span id="calcEstimatedDividend">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-content">
            <div class="modal-header">
                <h2 class="modal-title">Calculator</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="calculator-display">
                <div id="calculatorInput" class="input-line"></div>
                <div id="calculatorResult" class="result-line">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn function-btn" data-action="clear">C</button>
                <button class="calc-btn function-btn" data-action="percentage">%</button>
                <button class="calc-btn operator-btn" data-action="divide">÷</button>
                <button class="calc-btn digit-btn" data-value="7">7</button>
                <button class="calc-btn digit-btn" data-value="8">8</button>
                <button class="calc-btn digit-btn" data-value="9">9</button>
                <button class="calc-btn operator-btn" data-action="multiply">×</button>
                <button class="calc-btn digit-btn" data-value="4">4</button>
                <button class="calc-btn digit-btn" data-value="5">5</button>
                <button class="calc-btn digit-btn" data-value="6">6</button>
                <button class="calc-btn operator-btn" data-action="subtract">-</button>
                <button class="calc-btn digit-btn" data-value="1">1</button>
                <button class="calc-btn digit-btn" data-value="2">2</button>
                <button class="calc-btn digit-btn" data-value="3">3</button>
                <button class="calc-btn operator-btn" data-action="add">+</button>
                <button class="calc-btn digit-btn zero-btn" data-value="0">0</button>
                <button class="calc-btn digit-btn" data-value=".">.</button>
                <button class="calc-btn equals-btn" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div id="addWatchlistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Watchlist</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newWatchlistName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Watchlist Name:</label>
                    <input type="text" id="newWatchlistName" placeholder="e.g., Tech Stocks" required
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
            </div>
            <div class="modal-action-buttons">
                <button id="saveWatchlistBtn" class="button primary-button">Save Watchlist</button>
            </div>
        </div>
    </div>

    <!-- Manage Watchlist Modal -->
    <div id="manageWatchlistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Manage Watchlist</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editWatchlistName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Watchlist Name:</label>
                    <input type="text" id="editWatchlistName" required
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
            </div>
            <div class="modal-action-buttons">
                <button id="saveWatchlistNameBtn" class="button primary-button">Save Changes</button>
                <button id="deleteWatchlistInModalBtn" class="button danger-button">Delete Watchlist</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content custom-dialog-content">
            <p id="customDialogMessage" class="custom-dialog-message"></p>
            <div class="custom-dialog-buttons">
                <button id="customDialogConfirmBtn" class="button primary-button">Yes</button>
                <button id="customDialogCancelBtn" class="button secondary-button">No</button>
            </div>
        </div>
    </div>

    <!-- Share Context Menu -->
    <div id="shareContextMenu" class="context-menu">
        <button id="contextEditShareBtn" class="context-menu-item">Edit Share</button>
        <button id="contextDeleteShareBtn" class="context-menu-item danger-item">Delete Share</button>
    </div>

    <!-- Stock Search Modal -->
    <div id="stockSearchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="stockSearchTitle" class="modal-title">Search Stock</h2>
                <button class="search-close-button close-button">&times;</button>
            </div>
            <div class="modal-body-scrollable">
                <div class="form-group">
                    <label for="asxSearchInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search ASX Code or Company:</label>
                    <input type="text" id="asxSearchInput" placeholder="e.g., CBA or Commonwealth Bank"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <div id="asxSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <div id="searchResultDisplay" class="search-result-display">
                    <p class="initial-message">Start typing an ASX code to search.</p>
                </div>
            </div>
            <div class="modal-action-buttons-footer">
                <!-- Action buttons (Add to Watchlist / Edit Existing) will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Active Alerts Modal -->
    <div id="activeAlertsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Active Alerts (<span id="targetHitIconCount">0</span>)</h2>
                <button id="alertsCloseButton" class="alerts-close-button">&times;</button>
            </div>
            <div class="alerts-list-scrollable"> <!-- NEW: Wrapper for scrollable list -->
                <div id="activeAlertsList">
                    <!-- Alert items will be rendered here -->
                    <p class="no-alerts-message">No active alerts to display.</p>
                </div>
            </div>
            <div class="modal-action-buttons">
                <button id="minimizeAlertsModalBtn" class="button secondary-button">Minimize</button>
                <button id="dismissAllAlertsBtn" class="button primary-button">Dismiss All Alerts for this Session</button>
            </div>
        </div>
    </div>

    <!-- Cash Asset Form Modal -->
    <div id="cashAssetFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="cashFormTitle" class="modal-title">Add New Cash Asset</h2>
                <button class="cash-form-close-button close-button">&times;</button>
            </div>
            <div class="modal-body-scrollable">
                <div class="form-group">
                    <label for="cashAssetName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Asset Name:</label>
                    <input type="text" id="cashAssetName" placeholder="e.g., Savings Account" required
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <label for="cashAssetBalance" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Balance:</label>
                    <input type="number" step="0.01" id="cashAssetBalance" placeholder="0.00"
                        class="form-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="form-group">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="hideCashAssetCheckbox" class="toggle-switch">
                        <label for="hideCashAssetCheckbox" class="text-sm font-medium text-gray-700 dark:text-gray-300">Hide from Total</label>
                    </div>
                </div>
                <div class="form-group">
                    <div id="cashAssetCommentsArea">
                        <!-- Dynamic comment sections for cash assets will be added here -->
                    </div>
                    <button type="button" id="addCashAssetCommentBtn" class="button secondary-button mt-4">Add Comment Section</button>
                </div>
            </div>
            <div class="modal-action-buttons">
                <button id="saveCashAssetBtn" class="button primary-button">Save Asset</button>
                <button id="deleteCashAssetBtn" class="button danger-button hidden">Delete Asset</button>
            </div>
        </div>
    </div>

    <!-- Cash Asset Detail Modal -->
    <div id="cashAssetDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCashAssetName" class="modal-title"></h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body-scrollable">
                <p><strong>Asset Name:</strong> <span id="detailCashAssetName"></span></p>
                <p><strong>Current Balance:</strong> <span id="detailCashAssetBalance"></span></p>
                <p><strong>Last Updated:</strong> <span id="detailCashAssetLastUpdated"></span></p>
                <div class="comments-display-section">
                    <h3>Comments:</h3>
                    <div id="modalCashAssetCommentsContainer">
                        <!-- Comments will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="modal-action-buttons">
                <button id="editCashAssetFromDetailBtn" class="button secondary-button">Edit Asset</button>
                <button id="deleteCashAssetFromDetailBtn" class="button danger-button">Delete Asset</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, FieldValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app;
        let db;
        let auth;
        let currentAppId;
        let firebaseInitialized = false;

        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Sign in with custom token if available, otherwise anonymously
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                signInWithCustomToken(auth, __initial_auth_token)
                    .then(() => {
                        console.log("Firebase: Signed in with custom token.");
                        firebaseInitialized = true;
                    })
                    .catch((error) => {
                        console.error("Firebase: Custom token sign-in failed:", error);
                        // Fallback to anonymous if custom token fails
                        signInAnonymously(auth)
                            .then(() => {
                                console.log("Firebase: Signed in anonymously after custom token failure.");
                                firebaseInitialized = true;
                            })
                            .catch((anonError) => {
                                console.error("Firebase: Anonymous sign-in failed:", anonError);
                                const errorDiv = document.getElementById('firebaseInitError');
                                if (errorDiv) {
                                    errorDiv.textContent = `Firebase Init Error: ${anonError.message}`;
                                    errorDiv.style.display = 'block';
                                }
                                firebaseInitialized = false;
                            });
                    });
            } else {
                signInAnonymously(auth)
                    .then(() => {
                        console.log("Firebase: Signed in anonymously.");
                        firebaseInitialized = true;
                    })
                    .catch((error) => {
                        console.error("Firebase: Anonymous sign-in failed:", error);
                        const errorDiv = document.getElementById('firebaseInitError');
                        if (errorDiv) {
                            errorDiv.textContent = `Firebase Init Error: ${error.message}`;
                            errorDiv.style.display = 'block';
                        }
                        firebaseInitialized = false;
                    });
            }
        } catch (e) {
            console.error("Firebase: Error initializing Firebase:", e);
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.textContent = `Firebase Init Error: ${e.message}`;
                errorDiv.style.display = 'block';
            }
            firebaseInitialized = false;
        }

        // Expose Firebase objects globally for script.js
        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete,
            writeBatch: writeBatch
        } : null;

        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html script module loaded and DOMContentLoaded fired.");
        });
    </script>
    <!-- Linking to your separate script.js file -->
    <script src="script.js"></script>
</body>
</html>
