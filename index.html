<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Tracker</title>
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <!-- Linking to your separate style.css file -->
    <link rel="stylesheet" href="style.css?v=82"> <!-- Still v82 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <!-- Hamburger/Sidebar Toggle Button - NOW ON LEFT -->
            <button id="hamburgerBtn" class="hamburger-btn header-action-btn-left">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1> <!-- Default text before login -->
            <!-- New "Add Share" button on the main screen - NOW ON RIGHT -->
            <button id="addShareHeaderBtn" class="header-action-btn header-action-btn-right">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Mobile Menu / Desktop Sidebar Content -->
        <nav id="appSidebar" class="app-sidebar">
            <button id="closeMenuBtn" class="close-menu-btn">X</button>
            
            <div class="menu-section">
                <h3>Share Actions</h3>
                <div class="menu-buttons-group">
                    <!-- Add New Share - Icon with Text -->
                    <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-plus-circle"></i> <span>Add New Share</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Watchlists</h3>
                <div class="menu-buttons-group">
                    <!-- Add Watchlist - Icon with Text -->
                    <button id="addWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-list-ul"></i> <span>Add Watchlist</span>
                    </button>
                    <!-- Edit Current Watchlist - Icon with Text -->
                    <button id="editWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-edit"></i> <span>Edit Current Watchlist</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Calculators</h3>
                <div class="menu-buttons-group">
                    <!-- Standard Calculator - Icon with Text -->
                    <button id="standardCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-calculator"></i> <span>Standard</span>
                    </button>
                    <!-- Dividend Calculator - Icon with Text -->
                    <button id="dividendCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-money-bill-wave"></i> <span>Dividend</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Data Actions</h3>
                <div class="menu-buttons-group">
                    <!-- Export Watchlist Button -->
                    <button id="exportWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-file-export"></i> <span>Export Watchlist</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>App Settings</h3>
                <div class="menu-buttons-group">
                    <!-- Theme Toggle -->
                    <button id="themeToggleBtn" class="menu-button-item" data-action-closes-menu="false">
                        <i class="fas fa-moon"></i> <span>Dark Mode</span>
                    </button>
                    <!-- Color Theme Selection -->
                    <button id="colorThemeSelect" class="menu-button-item" data-action-closes-menu="false">
                        <i class="fas fa-palette"></i> <span>Color Theme</span>
                    </button>
                    <!-- Revert to Default Theme -->
                    <button id="revertToDefaultThemeBtn" class="menu-button-item icon-only" data-action-closes-menu="false">
                        <i class="fas fa-undo"></i><i class="fas fa-paint-roller"></i> 
                    </button>
                </div>
            </div>

            <div class="menu-section bottom-section">
                <div class="menu-buttons-group">
                    <!-- Google Sign-In/Out Button (always visible at the bottom) -->
                    <button id="googleAuthBtn" class="google-auth-btn menu-button-item" disabled>
                        <i class="fab fa-google"></i> Sign In
                    </button>
                    <!-- Logout Button - Changed to icon-only -->
                    <span id="logoutBtn" class="menu-button-item icon-only" data-action-closes-menu="true">
                        <i class="fas fa-sign-out-alt"></i>
                    </span>
                </div>
            </div>
        </nav>
        <div class="sidebar-overlay"></div>
    </header>

    <main class="content">
        <section id="shareListSection" class="share-list-section">
            <div class="watchlist-controls-row">
                <div class="watchlist-group">
                    <label for="watchlistSelect">Watchlist:</label>
                    <select id="watchlistSelect" class="dropdown-large" disabled>
                        <!-- New option for all watchlists -->
                        <option value="all_shares_option">All Watchlists</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="sort-group">
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect" class="dropdown-large" disabled>
                        <option value="shareName-asc">Name (A-Z)</option>
                        <option value="shareName-desc">Name (Z-A)</option>
                        <option value="currentPrice-desc">Current Price (High-Low)</option>
                        <option value="currentPrice-asc">Current Price (Low-High)</option>
                        <option value="dividendAmount-desc">Dividend (High-Low)</option>
                        <option value="dividendAmount-asc">Dividend (Low-High)</option>
                        <option value="unfrankedYield-desc">Unfranked Yield (High-Low)</option>
                        <option value="unfrankedYield-asc">Unfranked Yield (Low-High)</option>
                        <option value="frankingCredits-desc">Franking (High-Low)</option>
                        <option value="frankingCredits-asc">Franking (Low-High)</option>
                        <option value="targetPrice-desc">Target Price (High-Low)</option>
                        <option value="targetPrice-asc">Target Price (Low-High)</option>
                        <option value="entryDate-desc">Entry Date (Newest)</option>
                        <option value="entryDate-asc">Entry Date (Oldest)</option>
                    </select>
                </div>
            </div>

            <div class="loading" id="loadingIndicator" style="display: none;">
                Loading shares...
            </div>
            <div class="error-message" id="firebaseInitError" style="display: none;">
                Firebase did not initialize correctly. Please check your internet connection or browser settings.
            </div>

            <table id="shareTable">
                <thead>
                    <tr>
                        <th>Share Name</th>
                        <th>Current Price</th>
                        <th>Target Price</th>
                        <th>Dividend</th>
                        <th>Franking</th>
                        <th>Unfranked Yield</th>
                        <th>Franked Yield</th>
                        <th>Entered Price</th>
                        <th>Entry Date</th>
                        <th>Last Price Update</th>
                        <th class="table-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Share rows will be populated by JavaScript -->
                </tbody>
            </table>

            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be populated by JavaScript -->
            </div>
        </section>

        <!-- Share Form Modal -->
        <section id="shareFormSection" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="formTitle">Add New Share</h2>
                    <span class="form-close-button close-btn" aria-label="Close Share Form">&times;</span>
                </div>
                <div class="modal-body modal-body-scrollable">
                    <label for="shareName">Share Name:</label>
                    <input type="text" id="shareName" required placeholder="e.g., CBA, BHP" />

                    <label for="currentPrice">Current Price ($):</label>
                    <input type="number" id="currentPrice" step="0.01" min="0" placeholder="e.g., 100.50" />

                    <label for="targetPrice">Target Price ($):</label>
                    <input type="number" id="targetPrice" step="0.01" min="0" placeholder="e.g., 105.00" />

                    <label for="dividendAmount">Dividend Amount ($ per share):</label>
                    <input type="number" id="dividendAmount" step="0.01" min="0" placeholder="e.g., 2.50" />

                    <label for="frankingCredits">Franking Credits (%):</label>
                    <input type="number" id="frankingCredits" step="any" min="0" max="100" placeholder="e.g., 70, 100 (for fully franked)" />

                    <div id="commentsFormContainer" class="comments-form-container">
                        <!-- Comments will be added here by JavaScript -->
                    </div>
                    <span id="addCommentSectionBtn" class="modal-action-icon add-comment-btn" aria-label="Add Comment">
                        <i class="fas fa-comment-dots"></i> Add Comment
                    </span>
                </div>
                <div class="modal-footer">
                    <span id="deleteShareBtn" class="modal-action-icon delete-icon hidden" aria-label="Delete Share">
                        <i class="fas fa-trash-alt"></i>
                    </span>
                    <span id="cancelFormBtn" class="modal-action-icon cancel-icon" aria-label="Cancel">
                        <i class="fas fa-times-circle"></i>
                    </span>
                    <span id="saveShareBtn" class="modal-action-icon save-icon" aria-label="Save Share">
                        <i class="fas fa-check-circle"></i>
                    </span>
                </div>
            </div>
        </section>

        <!-- Share Details Modal -->
        <section id="shareDetailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalShareName">Share Details</h2>
                    <span class="close-btn" aria-label="Close Share Details">&times;</span>
                </div>
                <div class="modal-body modal-body-scrollable">
                    <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                    <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span></p>
                    <p><strong>Current Price:</strong> <span id="modalCurrentPrice"></span></p>
                    <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                    <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
                    <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
                    <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                    <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>
                    <div class="comments-display-container" id="modalCommentsContainer">
                        <!-- Comments will be displayed here -->
                    </div>

                    <div class="external-links">
                        <p>More Info:</p>
                        <a id="modalMarketIndexLink" href="#" target="_blank" class="external-link-btn" style="display: none;">
                            <i class="fas fa-chart-line"></i> Market Index
                        </a>
                        <a id="modalFoolLink" href="#" target="_blank" class="external-link-btn" style="display: none;">
                            <i class="fas fa-money-bill-alt"></i> Motley Fool
                        </a>
                        <a id="modalCommSecLink" href="#" target="_blank" class="external-link-btn" style="display: none;">
                            <i class="fas fa-university"></i> CommSec
                        </a>
                        <p id="commSecLoginMessage" class="ghosted-text" style="display: none;">
                            Note: CommSec links may require a login to view content.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <span id="editShareFromDetailBtn" class="modal-action-icon edit-icon" aria-label="Edit Share">
                        <i class="fas fa-edit"></i>
                    </span>
                </div>
            </div>
        </section>

        <!-- Dividend Calculator Modal -->
        <section id="dividendCalculatorModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Dividend Calculator</h2>
                    <span class="calc-close-button close-btn" aria-label="Close Calculator">&times;</span>
                </div>
                <div class="modal-body">
                    <label for="calcCurrentPrice">Current Price ($):</label>
                    <input type="number" id="calcCurrentPrice" step="0.01" min="0" placeholder="e.g., 100.50" />

                    <label for="calcDividendAmount">Dividend Amount ($ per share):</label>
                    <input type="number" id="calcDividendAmount" step="0.01" min="0" placeholder="e.g., 2.50" />

                    <label for="calcFrankingCredits">Franking Credits (%):</label>
                    <input type="number" id="calcFrankingCredits" step="any" min="0" max="100" placeholder="e.g., 70, 100 (for fully franked)" />

                    <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">0.00%</span></p>
                    <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">0.00%</span></p>

                    <label for="investmentValueSelect">Estimated Investment Value ($):</label>
                    <input type="number" id="investmentValueSelect" step="1" min="0" placeholder="e.g., 1000, 5000" />
                    
                    <p><strong>Estimated Annual Dividend:</strong> <span id="calcEstimatedDividend">$0.00</span></p>
                </div>
            </div>
        </section>

        <!-- Universal Calculator Modal -->
        <section id="calculatorModal" class="modal">
            <div class="modal-content calculator-content">
                <div class="modal-header">
                    <h2>Calculator</h2>
                    <span class="close-btn" aria-label="Close Calculator">&times;</span>
                </div>
                <div class="modal-body calculator-body">
                    <div class="calculator-display">
                        <div id="calculatorInput" class="input"></div>
                        <div id="calculatorResult" class="result">0</div>
                    </div>
                    <div class="calculator-buttons">
                        <!-- Buttons will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Custom Dialog Modal (for alerts and confirms) -->
        <section id="customDialogModal" class="modal custom-dialog-modal">
            <div class="modal-content custom-dialog-content">
                <div class="modal-body">
                    <p id="customDialogMessage"></p>
                </div>
                <div class="modal-footer">
                    <span id="customDialogConfirmBtn" class="modal-action-icon dialog-confirm-icon" aria-label="Confirm">
                        <i class="fas fa-check-circle"></i>
                    </span>
                    <span id="customDialogCancelBtn" class="modal-action-icon dialog-cancel-icon" aria-label="Cancel">
                        <i class="fas fa-times-circle"></i>
                    </span>
                </div>
            </div>
        </section>

        <!-- Add Watchlist Modal -->
        <section id="addWatchlistModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New Watchlist</h2>
                    <span class="close-btn" aria-label="Close Add Watchlist Modal">&times;</span>
                </div>
                <div class="modal-body">
                    <label for="newWatchlistName">Watchlist Name:</label>
                    <input type="text" id="newWatchlistName" required placeholder="e.g., My Growth Stocks" />
                </div>
                <div class="modal-footer">
                    <span id="cancelAddWatchlistBtn" class="modal-action-icon cancel-icon" aria-label="Cancel">
                        <i class="fas fa-times-circle"></i>
                    </span>
                    <span id="saveWatchlistBtn" class="modal-action-icon save-icon" aria-label="Save Watchlist">
                        <i class="fas fa-check-circle"></i>
                    </span>
                </div>
            </div>
        </section>

        <!-- Manage Watchlist Modal -->
        <section id="manageWatchlistModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Watchlist</h2>
                    <span class="close-btn" aria-label="Close Edit Watchlist Modal">&times;</span>
                </div>
                <div class="modal-body">
                    <label for="editWatchlistName">Watchlist Name:</label>
                    <input type="text" id="editWatchlistName" required />
                </div>
                <div class="modal-footer">
                    <span id="deleteWatchlistInModalBtn" class="modal-action-icon delete-icon" aria-label="Delete Watchlist">
                        <i class="fas fa-trash-alt"></i>
                    </span>
                    <span id="cancelManageWatchlistBtn" class="modal-action-icon cancel-icon" aria-label="Cancel">
                        <i class="fas fa-times-circle"></i>
                    </span>
                    <span id="saveWatchlistNameBtn" class="modal-action-icon save-icon" aria-label="Save Changes">
                        <i class="fas fa-check-circle"></i>
                    </span>
                </div>
            </div>
        </section>

        <!-- Context Menu for Shares (right-click/long-press) -->
        <div id="shareContextMenu" class="context-menu">
            <button id="contextEditShareBtn">
                <i class="fas fa-edit"></i> Edit Share
            </button>
            <button id="contextDeleteShareBtn">
                <i class="fas fa-trash-alt"></i> Delete Share
            </button>
        </div>

    </main>

    <footer class="fixed-footer">
        <button id="scrollToTopBtn" class="scroll-to-top-btn" aria-label="Scroll to top">
            <i class="fas fa-arrow-up"></i>
        </button>
    </footer>

    <!-- Firebase SDK (Version 11.6.1 - compatible with modular import) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <script type="module">
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "[YOUR_API_KEY]",
            authDomain: "[YOUR_AUTH_DOMAIN]",
            projectId: "[YOUR_PROJECT_ID]",
            storageBucket: "[YOUR_STORAGE_BUCKET]",
            messagingSenderId: "[YOUR_MESSAGING_SENDER_ID]",
            appId: "[YOUR_APP_ID]"
        };

        let firebaseInitialized = false;
        let db = null;
        let auth = null;
        let currentAppId = null;

        try {
            // Initialize Firebase if not already initialized
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            currentAppId = firebaseConfig.appId;
            firebaseInitialized = true;
            console.log("Firebase app initialized successfully in index.html module script.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
            firebaseInitialized = false;
        }

        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: firebase.firestore.collection,
            doc: firebase.firestore.doc,
            getDoc: firebase.firestore.getDoc,
            addDoc: firebase.firestore.addDoc,
            setDoc: firebase.firestore.setDoc,
            updateDoc: firebase.firestore.updateDoc,
            deleteDoc: firebase.firestore.deleteDoc,
            onSnapshot: firebase.firestore.onSnapshot,
            query: firebase.firestore.query,
            where: firebase.firestore.where,
            getDocs: firebase.firestore.getDocs,
            deleteField: firebase.firestore.FieldValue.delete,
            writeBatch: firebase.firestore.writeBatch
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: firebase.auth.GoogleAuthProvider,
            signInAnonymously: firebase.auth.signInAnonymously,
            signInWithCustomToken: firebase.auth.signInWithCustomToken,
            signInWithPopup: firebase.auth.signInWithPopup,
            signOut: firebase.auth.signOut,
            onAuthSt<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Tracker</title>
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <!-- Linking to your separate style.css file -->
    <link rel="stylesheet" href="style.css?v=81"> <!-- Updated to v81 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <!-- Hamburger/Sidebar Toggle Button - NOW ON LEFT -->
            <button id="hamburgerBtn" class="hamburger-btn header-action-btn-left">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1> <!-- Default text before login -->
            <!-- New "Add Share" button on the main screen - NOW ON RIGHT -->
            <button id="addShareHeaderBtn" class="header-action-btn header-action-btn-right">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Mobile Menu / Desktop Sidebar Content -->
        <nav id="appSidebar" class="app-sidebar">
            <button id="closeMenuBtn" class="close-menu-btn">X</button>
            
            <div class="menu-section">
                <h3>Share Actions</h3>
                <div class="menu-buttons-group">
                    <!-- Add New Share - Icon with Text -->
                    <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-plus-circle"></i> <span>Add New Share</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Watchlists</h3>
                <div class="menu-buttons-group">
                    <!-- Add Watchlist - Icon with Text -->
                    <button id="addWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-list-ul"></i> <span>Add Watchlist</span>
                    </button>
                    <!-- Edit Current Watchlist - Icon with Text -->
                    <button id="editWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-edit"></i> <span>Edit Current Watchlist</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Calculators</h3>
                <div class="menu-buttons-group">
                    <!-- Standard Calculator - Icon with Text -->
                    <button id="standardCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-calculator"></i> <span>Standard</span>
                    </button>
                    <!-- Dividend Calculator - Icon with Text -->
                    <button id="dividendCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-money-bill-wave"></i> <span>Dividend</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Data Actions</h3>
                <div class="menu-buttons-group">
                    <!-- Export Watchlist Button - NEW -->
                    <button id="exportWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-file-export"></i> <span>Export Watchlist (CSV)</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Theme</h3>
                <div class="menu-buttons-group">
                    <!-- Theme Toggle Button - Icon with Text -->
                    <button id="themeToggleBtn" class="menu-button-item" data-action-closes-menu="false">
                        <i class="fas fa-palette"></i> <span>Theme</span>
                    </button>
                    
                    <!-- New Theme Selector Dropdown -->
                    <label for="colorThemeSelect" class="theme-select-label">Choose Color Theme:</label>
                    <select id="colorThemeSelect" class="dropdown-large menu-dropdown" data-action-closes-menu="false">
                        <option value="none" selected>No Custom Theme</option>
                        <optgroup label="Bold Themes">
                            <option value="bold-1">Bold Ocean</option>
                            <option value="bold-2">Bold Forest</option>
                            <option value="bold-3">Bold Sunset</option>
                            <option value="bold-4">Bold Royal</option>
                            <option value="bold-5">Bold Grape</option>
                            <option value="bold-6">Bold Fire</option>
                            <option value="bold-7">Bold Emerald</option>
                            <option value="bold-8">Bold Plum</option>
                            <option value="bold-9">Bold Aqua</option>
                            <option value="bold-10">Bold Ruby</option>
                        </optgroup>
                        <optgroup label="Subtle Themes">
                            <option value="subtle-1">Subtle Sky</option>
                            <option value="subtle-2">Subtle Earth</option>
                            <option value="subtle-3">Subtle Rose</option>
                            <option value="subtle-4">Subtle Lavender</option>
                            <option value="subtle-5">Subtle Mint</option>
                            <option value="subtle-6">Subtle Sand</option>
                            <option value="subtle-7">Subtle Graphite</option>
                            <option value="subtle-8">Subtle Peach</option>
                            <option value="subtle-9">Subtle Teal</option>
                            <option value="subtle-10">Subtle Stone</option>
                        </optgroup>
                    </select>

                    <!-- Revert to Default Theme Button - Icon with Text -->
                    <button id="revertToDefaultThemeBtn" class="menu-button-item secondary-buttons" data-action-closes-menu="false">
                        <i class="fas fa-sun"></i><i class="fas fa-moon"></i> <span>Default Theme</span>
                    </button>
                </div>
            </div>
            
            <!-- Logout Button Section - Icon with Text -->
            <div class="menu-section logout-section">
                <h3>Account</h3>
                <div class="menu-buttons-group">
                    <!-- Changed to span for standalone icon behavior -->
                    <span id="logoutBtn" class="menu-button-item danger-button" data-action-closes-menu="true">
                        <i class="fas fa-sign-out-alt"></i> <span>Log Out</span>
                    </span>
                </div>
            </div>
        </nav>

        <!-- Sidebar overlay for desktop to handle clicks outside -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <!-- Watchlist and Sort controls -->
        <div class="watchlist-controls-row">
            <div class="watchlist-group">
                <select id="watchlistSelect" class="dropdown-large">
                    <!-- Added "All Watchlists" option -->
                    <option value="all_shares_option">All Watchlists</option>
                    <!-- Options populated by JS, including 'Watchlist' placeholder -->
                </select>
            </div>

            <div class="sort-group">
                <select id="sortSelect" class="dropdown-large">
                    <option value="" disabled selected>Sort by</option> <!-- Explicit "Sort by" placeholder -->
                    <option value="entryDate-desc">Date Added (Newest)</option>
                    <option value="entryDate-asc">Date Added (Oldest)</option>
                    <option value="shareName-asc">Code (A-Z)</option>
                    <option value="shareName-desc">Code (Z-A)</option>
                    <option value="dividendAmount-desc">Dividend (High-Low)</option>
                    <option value="dividendAmount-asc">Dividend (Low-High)</option>
                </select>
            </div>
        </div>
        
        <!-- ASX Code buttons container -->
        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
            <!-- ASX code buttons will be dynamically added here -->
        </div>
    </header>

    <main class="container">
        <!-- Message for Firebase initialization errors -->
        <div id="firebaseInitError" class="error-message" style="display: none;">
            <p><strong>Error:</strong> Firebase failed to initialize.</p>
            <p>This is usually due to missing or incorrect Firebase configuration. Please ensure your <code>firebaseConfig</code> in <code>index.html</code> is correctly set up from your Firebase project settings.</p>
            <p>Core application features will not work without a valid Firebase connection.</p>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">Loading shares...</div>
        <div class="share-list-section">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Entered Price</th>
                            <th>Target Price</th>
                            <th>Dividends</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be dynamically added here -->
            </div>
        </div>
    </main>

    <footer class="fixed-footer">
        <button id="googleAuthBtn" class="google-auth-btn">Sign In</button>
    </footer>

    <!-- Scroll-to-Top Button -->
    <button id="scrollToTopBtn" title="Go to top"><i class="fas fa-arrow-up"></i></button>

    <!-- Modals -->
    <!-- Share Form Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content">
            <!-- Header with close button and title -->
            <div class="modal-header-with-icon">
                <span class="close-button form-close-button">&times;</span>
                <h2 id="formTitle">Add New Share</h2>
            </div>
            
            <!-- Scrollable content area for the form inputs and comments -->
            <div class="modal-body-scrollable">
                <label for="shareName">Code:</label>
                <input type="text" id="shareName" placeholder="e.g., BHP" required>

                <label for="currentPrice">Entered Price ($):</label>
                <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 25.50">

                <label for="targetPrice">Target Price ($):</label>
                <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 30.00">

                <label for="dividendAmount">Dividend Amount (per share, annual $):</label>
                <input type="number" id="dividendAmount" step="0.001" placeholder="e.g., 1.250">

                <label for="frankingCredits">Franking Credits (%):</label>
                <input type="number" id="frankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70 for 70%">

                <!-- Comments section container -->
                <div id="commentsFormContainer" class="comments-form-container">
                    <!-- ADDED PLUS ICON HERE (NOT A BUTTON) -->
                    <h3>Comments <span id="addCommentSectionBtn" class="add-section-icon"><i class="fas fa-plus"></i></span></h3>
                    <!-- Initial comment section will be added here by JS -->
                </div>
            </div>
            <!-- END Scrollable content area -->

            <!-- Sticky footer for action icons -->
            <div class="form-action-buttons modal-form-buttons sticky-footer">
                <!-- Delete Icon -->
                <span id="deleteShareBtn" class="modal-action-icon danger hidden" title="Delete"><i class="fas fa-trash-alt"></i></span>
                <!-- Cancel Icon -->
                <span id="cancelFormBtn" class="modal-action-icon secondary" title="Cancel"><i class="fas fa-times-circle"></i></span>
                <!-- Save Share Icon -->
                <span id="saveShareBtn" class="modal-action-icon" title="Save Share"><i class="fas fa-save"></i></span>
            </div>
        </div>
    </div>

    <!-- Share Details Modal (Still needed for double-click on table/card) -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName">Share Details</h2>
            
            <!-- NEW: Scrollable content for share details modal -->
            <div class="modal-body-scrollable">
                <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span></p>
                <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
                <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
                <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>

                <div id="modalCommentsContainer" class="modal-comments-sections">
                    <h3>Comments</h3>
                    <!-- Comments will be displayed here -->
                </div>

                <div class="external-links-section">
                    <h3>External Links</h3>
                    <p><a id="modalMarketIndexLink" href="#" target="_blank" class="external-link"><i class="fas fa-external-link-alt"></i> View on MarketIndex.com.au</a></p>
                    <p><a id="modalFoolLink" href="#" target="_blank" class="external-link"><i class="fas fa-external-link-alt"></i> View on Fool.com.au</a></p>
                    <p><a id="modalCommSecLink" href="#" target="_blank" class="external-link"><i class="fas fa-external-link-alt"></i> View on CommSec.com.au</a></p>
                    <p id="commSecLoginMessage" class="ghosted-text commsec-message">Requires single CommSec login per session</p>
                </div>
            </div>
            <!-- END NEW: Scrollable content for share details modal -->

            <div class="modal-action-buttons">
                <!-- Edit Share icon - NOW STANDALONE ICON -->
                <span id="editShareFromDetailBtn" class="modal-action-icon" title="Edit Share"><i class="fas fa-edit"></i></span>
            </div>
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div id="addWatchlistModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Add New Watchlist</h2>
            <label for="newWatchlistName">Watchlist Name:</label>
            <input type="text" id="newWatchlistName" placeholder="e.g., Tech Stocks" required>
            <div class="form-action-buttons">
                <!-- Cancel Add Watchlist icon - NOW STANDALONE ICON -->
                <span id="cancelAddWatchlistBtn" class="modal-action-icon secondary" title="Cancel"><i class="fas fa-times-circle"></i></span>
                <!-- Save Watchlist icon - NOW STANDALONE ICON -->
                <span id="saveWatchlistBtn" class="modal-action-icon" title="Save Watchlist"><i class="fas fa-save"></i></span>
            </div>
        </div>
    </div>

    <!-- Manage Watchlist Modal (New) -->
    <div id="manageWatchlistModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Manage Watchlist</h2>
            <label for="editWatchlistName">Watchlist Name:</label>
            <input type="text" id="editWatchlistName" required>
            <div class="form-action-buttons">
                <!-- Delete Watchlist icon - NOW STANDALONE ICON -->
                <span id="deleteWatchlistInModalBtn" class="modal-action-icon danger" title="Delete Watchlist"><i class="fas fa-trash-alt"></i></span>
                <!-- Cancel Manage Watchlist icon - NOW STANDALONE ICON -->
                <span id="cancelManageWatchlistBtn" class="modal-action-icon secondary" title="Cancel"><i class="fas fa-times-circle"></i></span>
                <!-- Save Watchlist Name icon - NOW STANDALONE ICON -->
                <span id="saveWatchlistNameBtn" class="modal-action-icon" title="Save Name"><i class="fas fa-save"></i></span>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button calc-close-button">&times;</span>
            <h2>Dividend Calculator</h2>
            <div class="calc-input-group">
                <label for="calcCurrentPrice">Share Price ($):</label>
                <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 25.50">
            </div>
            <div class="calc-input-group">
                <label for="calcDividendAmount">Dividend Amount (per share, annual $):</label>
                <input type="number" id="calcDividendAmount" step="0.001" placeholder="e.g., 1.250">
            </div>
            <div class="calc-input-group">
                <label for="frankingCredits">Franking Credits (%):</label>
                <input type="number" id="calcFrankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70 for 70%">
            </div>
            <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
            <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">-</span></p>
            <hr>
            <div class="calc-input-group">
                <label for="investmentValueSelect">Investment Value:</label>
                <select id="investmentValueSelect">
                    <option value="1000">$1,000</option>
                    <option value="5000">$5,000</option>
                    <option value="10000" selected>$10,000</option>
                    <option value="25000">$25,000</option>
                    <option value="50000">$50,000</option>
                    <option value="100000">$100,000</option>
                </select>
            </div>
            <p><strong>Estimated Annual Dividend:</strong> <span id="calcEstimatedDividend">-</span></p>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button">&times;</span>
            <h2>Standard Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input"></div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <!-- Row 1: C, %, √∑ -->
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">√∑</button>
                
                <!-- Row 2: 7, 8, 9, √ó -->
                <button class="calc-btn" data-value="7">7</button>
                <button class="calc-btn" data-value="8">8</button>
                <button class="calc-btn" data-value="9">9</button>
                <button class="calc-btn operator" data-action="multiply">√ó</button>
                
                <!-- Row 3: 4, 5, 6, - -->
                <button class="calc-btn" data-value="4">4</button>
                <button class="calc-btn" data-value="5">5</button>
                <button class="calc-btn" data-value="6">6</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                
                <!-- Row 4: 1, 2, 3, + -->
                <button class="calc-btn" data-value="1">1</button>
                <button class="calc-btn" data-value="2">2</button>
                <button class="calc-btn" data-value="3">3</button>
                <button class="calc-btn operator" data-action="add">+</button>
                
                <!-- Row 5: 0 (span 2), ., = (span 1) -->
                <button class="calc-btn zero" data-value="0">0</button>
                <button class="calc-btn" data-value=".">.</button>
                <button class="calc-btn equals" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal for Alerts/Confirms -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <p id="customDialogMessage"></p>
            <div class="custom-dialog-buttons">
                <!-- Yes/Confirm Icon - NOW STANDALONE ICON -->
                <span id="customDialogConfirmBtn" class="modal-action-icon" title="Yes"><i class="fas fa-check-circle"></i></span>
                <!-- No/Cancel Icon - NOW STANDALONE ICON -->
                <span id="customDialogCancelBtn" class="modal-action-icon danger" title="No"><i class="fas fa-times-circle"></i></span>
            </div>
        </div>
    </div>

    <!-- Context Menu for Share Actions (Long Press / Right Click) -->
    <div id="shareContextMenu" class="context-menu">
        <button id="contextEditShareBtn" class="context-menu-item"><i class="fas fa-edit"></i> Edit Share</button>
        <button id="contextDeleteShareBtn" class="context-menu-item danger-button"><i class="fas fa-trash-alt"></i> Delete Share</button>
    </div>

    <!-- Firebase and main script loading -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, FieldValue, deleteField, writeBatch, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Added collectionGroup

        // YOUR FIREBASE CONFIGURATION - THIS HAS BEEN INSERTED BASED ON YOUR PROVIDED DETAILS
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
            authDomain: "asx-watchlist-app.firebaseapp.com",
            projectId: "asx-watchlist-app",
            storageBucket: "asx-watchlist-app.firebasestorage.app",
            messagingSenderId: "671024168765",
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
            measurementId: "G-J24BTJ34D2"
        };
        // END OF FIREBASE CONFIGURATION

        const currentAppId = firebaseConfig.projectId || 'default-app-id';

        let firebaseApp;
        let auth;
        let db;
        let firebaseInitialized = false;

        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                firebaseInitialized = true;
                console.log("Firebase: Initialized successfully with config.");
            } catch (error) {
                console.error("Firebase: Failed to initialize app with provided config:", error);
                firebaseInitialized = false;
            }
        } else {
            console.error("Firebase: Configuration is missing or invalid (apiKey or projectId). Firebase will not initialize.");
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
            firebaseInitialized = false;
        }

        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete,
            writeBatch: writeBatch,
            collectionGroup: collectionGroup // Added collectionGroup
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v81) script module loaded and DOMContentLoaded fired."); // Updated version number
        }); 
    </script>
    <!-- Linking to your separate script.js file -->
    <script src="script.js?v=146"></script> <!-- Updated to v146 -->
</body>
</html>
ateChanged: firebase.auth.onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v79) script module loaded and DOMContentLoaded fired."); // Updated version number
        }); 
    </script>
    <!-- Linking to your separate script.js file -->
    <script src="script.js?v=144"></script> <!-- Still v144 -->
</body>
</html>
