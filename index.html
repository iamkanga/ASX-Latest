<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Tracker</title>
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <!-- Linking to your separate style.css file -->
    <link rel="stylesheet" href="style.css?v=82"> <!-- Updated to v82 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <!-- Hamburger/Sidebar Toggle Button - NOW ON LEFT -->
            <button id="hamburgerBtn" class="hamburger-btn header-action-btn-left">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1> <!-- Default text before login -->
            <!-- New "Add Share" button on the main screen - NOW ON RIGHT -->
            <button id="addShareHeaderBtn" class="header-action-btn header-action-btn-right">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Mobile Menu / Desktop Sidebar Content -->
        <nav id="appSidebar" class="app-sidebar">
            <button id="closeMenuBtn" class="close-menu-btn">X</button>
            
            <div class="menu-section">
                <h3>Share Actions</h3>
                <div class="menu-buttons-group">
                    <!-- Add New Share - Icon with Text -->
                    <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-plus-circle"></i> <span>Add New Share</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Watchlists</h3>
                <div class="menu-buttons-group">
                    <!-- Add Watchlist - Icon with Text -->
                    <button id="addWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-list-ul"></i> <span>Add Watchlist</span>
                    </button>
                    <!-- Edit Current Watchlist - Icon with Text -->
                    <button id="editWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-edit"></i> <span>Edit Current Watchlist</span>
                    </button>
                </div>
            </div>

            <div class="menu-section">
                <h3>Calculators</h3>
                <div class="menu-buttons-group">
                    <!-- Standard Calculator - Icon with Text -->
                    <button id="standardCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-calculator"></i> <span>Standard</span>
                    </button>
                    <!-- Dividend Calculator - Icon with Text -->
                    <button id="dividendCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-money-bill-wave"></i> <span>Dividend</span>
                    </button>
                </div>
            </div>
            
            <div class="menu-section">
                <h3>Tools</h3>
                <div class="menu-buttons-group">
                    <!-- Theme Toggle -->
                    <button id="themeToggleBtn" class="menu-button-item" data-action-closes-menu="false">
                        <i class="fas fa-lightbulb"></i> <span>Dark/Light Mode</span>
                    </button>
                    <!-- Color Theme Selector -->
                    <div class="menu-item-with-select">
                        <i class="fas fa-palette menu-icon-align"></i> 
                        <select id="colorThemeSelect" class="menu-select-item">
                            <option value="system-default">System Default</option>
                            <option value="dark">Dark Theme</option>
                            <optgroup label="Bold Themes">
                                <option value="bold-1">Ocean Blue</option>
                                <option value="bold-2">Forest Green</option>
                                <option value="bold-3">Sunset Orange</option>
                                <option value="bold-4">Royal Purple</option>
                                <option value="bold-5">Ruby Red</option>
                                <option value="bold-6">Goldenrod</option>
                                <option value="bold-7">Deep Teal</option>
                                <option value="bold-8">Burnt Sienna</option>
                                <option value="bold-9">Lime Punch</option>
                                <option value="bold-10">Amethyst</option>
                            </optgroup>
                            <optgroup label="Subtle Themes">
                                <option value="subtle-1">Sky Mist</option>
                                <option value="subtle-2">Mint Whisper</option>
                                <option value="subtle-3">Sandstone</option>
                                <option value="subtle-4">Lavender Haze</option>
                                <option value="subtle-5">Rose Blush</option>
                                <option value="subtle-6">Ocean Breeze</option>
                                <option value="subtle-7">Eucalyptus</option>
                                <option value="subtle-8">Plum Touch</option>
                                <option value="subtle-9">Soft Gray</option>
                                <option value="subtle-10">Peach Cream</option>
                            </optgroup>
                        </select>
                    </div>
                    <button id="revertToDefaultThemeBtn" class="menu-button-item" data-action-closes-menu="false">
                        <i class="fas fa-undo"></i> <span>Reset Theme</span>
                    </button>
                    <button id="exportWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fas fa-file-export"></i> <span>Export Watchlist</span>
                    </button>
                </div>
            </div>

            <div class="menu-section menu-section-bottom">
                <h3>Account</h3>
                <div class="menu-buttons-group">
                    <button id="googleAuthBtn" class="menu-button-item" data-action-closes-menu="true">
                        <i class="fab fa-google"></i> <span>Sign In</span>
                    </button>
                    <!-- Logout button (icon only) - Span with setIconDisabled helper -->
                    <span id="logoutBtn" class="menu-button-item logout-icon-only-btn" data-action-closes-menu="true">
                        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                    </span>
                </div>
            </div>
        </nav>
        <div class="sidebar-overlay"></div> <!-- Overlay to close sidebar on tap outside -->
    </header>

    <main>
        <div id="firebaseInitError" class="error-message" style="display: none;">
            Firebase is not initialized. Please ensure your Firebase configuration is correct and try again.
        </div>
        <div id="loadingIndicator" class="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>

        <!-- Watchlist Controls (Dropdown & Multi-Select) -->
        <div class="watchlist-controls-row">
            <div class="watchlist-group">
                <label for="watchlistSelect">Active Watchlist:</label>
                <select id="watchlistSelect" class="dropdown-large">
                    <!-- Options populated by JavaScript -->
                    <option value="" disabled selected>Loading Watchlists...</option>
                </select>
            </div>

            <div class="sort-group">
                <label for="sortSelect">Sort By:</label>
                <select id="sortSelect" class="dropdown-small">
                    <option value="entryDate-desc">Date Added (Newest)</option>
                    <option value="entryDate-asc">Date Added (Oldest)</option>
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="enteredPrice-desc">Entered Price (High to Low)</option>
                    <option value="enteredPrice-asc">Entered Price (Low to High)</option>
                    <option value="currentPrice-desc">Current Price (High to Low)</option>
                    <option value="currentPrice-asc">Current Price (Low to High)</option>
                    <option value="targetPrice-desc">Target Price (High to Low)</option>
                    <option value="targetPrice-asc">Target Price (Low to High)</option>
                    <option value="dividendAmount-desc">Dividend Amount (High to Low)</option>
                    <option value="dividendAmount-asc">Dividend Amount (Low to High)</option>
                    <option value="unfrankedYield-desc">Unfranked Yield (High to Low)</option>
                    <option value="unfrankedYield-asc">Unfranked Yield (Low to High)</option>
                    <option value="frankedYield-desc">Franked Yield (High to Low)</option>
                    <option value="frankedYield-asc">Franked Yield (Low to High)</option>
                </select>
            </div>
        </div>
        
        <!-- Main Share List Section (Table for Desktop, Cards for Mobile) -->
        <section class="share-list-section">
            <h2>Your Shares</h2>
            <div class="table-responsive">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>Share Name</th>
                            <th>Entry Date</th>
                            <th>Entered Price</th>
                            <th>Current Price</th>
                            <th>Target Price</th>
                            <th>Dividend Amt</th>
                            <th>Franking %</th>
                            <th>Unfranked Yield</th>
                            <th>Franked Yield</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be populated by JavaScript -->
            </div>
        </section>

        <!-- Share Form Modal (Add/Edit Share) -->
        <section id="shareFormSection" class="modal">
            <div class="modal-content">
                <span class="close-button form-close-button">&times;</span>
                <h2 id="formTitle">Add New Share</h2>
                <form id="shareForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shareName">Share Name:</label>
                            <input type="text" id="shareName" required>
                        </div>
                        <div class="form-group">
                            <label for="entryDate">Entry Date:</label>
                            <input type="date" id="entryDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="enteredPrice">Entered Price:</label>
                            <input type="number" id="enteredPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="currentPrice">Current Price:</label>
                            <input type="number" id="currentPrice" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="targetPrice">Target Price:</label>
                            <input type="number" id="targetPrice" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="dividendAmount">Dividend Amount (per share):</label>
                            <input type="number" id="dividendAmount" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="frankingCredits">Franking Credits (%):</label>
                            <input type="number" id="frankingCredits" step="0.01" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label for="asxCodeButtonsContainer">ASX Code Suggestions:</label>
                            <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
                                <!-- Buttons will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div id="commentsFormContainer" class="comments-section-container">
                        <h3>Comments</h3>
                        <!-- Comments will be dynamically added here -->
                    </div>
                    <span id="addCommentSectionBtn" class="button-icon-text-link add-comment-btn" role="button" tabindex="0">
                        <i class="fas fa-plus"></i> Add Comment
                    </span>

                    <div class="form-actions">
                        <span id="saveShareBtn" class="button-icon-text-link save-btn" role="button" tabindex="0">
                            <i class="fas fa-save"></i> Save Share
                        </span>
                        <span id="cancelFormBtn" class="button-icon-text-link cancel-btn" role="button" tabindex="0">
                            <i class="fas fa-times-circle"></i> Cancel
                        </span>
                        <span id="deleteShareBtn" class="button-icon-text-link delete-btn" role="button" tabindex="0">
                            <i class="fas fa-trash-alt"></i> Delete Share
                        </span>
                    </div>
                </form>
            </div>
        </section>

        <!-- Share Detail Modal (View Share Details) -->
        <section id="shareDetailModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModals()">&times;</span>
                <h2 id="modalShareName">Share Details</h2>
                <div class="modal-body-scrollable">
                    <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                    <p><strong>Entered Price:</strong> $<span id="modalEnteredPrice"></span></p>
                    <p><strong>Current Price:</strong> $<span id="modalCurrentPrice"></span></p>
                    <p><strong>Target Price:</strong> $<span id="modalTargetPrice"></span></p>
                    <p><strong>Dividend Amount:</strong> $<span id="modalDividendAmount"></span></p>
                    <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span>%</p>
                    <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span>%</p>
                    <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span>%</p>

                    <div class="info-section">
                        <h3>Comments</h3>
                        <div id="modalCommentsContainer" class="comments-display-container">
                            <!-- Comments will be displayed here -->
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>External Links</h3>
                        <div class="external-links-container">
                            <a id="modalNewsLink" href="#" target="_blank" class="external-link-button"><i class="fas fa-newspaper"></i> News</a>
                            <a id="modalMarketIndexLink" href="#" target="_blank" class="external-link-button"><i class="fas fa-chart-line"></i> Market Index</a>
                            <a id="modalFoolLink" href="#" target="_blank" class="external-link-button"><i class="fas fa-hat-wizard"></i> Motley Fool</a>
                            <a id="modalCommSecLink" href="#" target="_blank" class="external-link-button commsec-link"><i class="fas fa-sign-in-alt"></i> CommSec</a>
                        </div>
                        <p id="commSecLoginMessage" class="commsec-message">
                            (Note: CommSec link requires you to be logged into CommSec in your browser for direct access.)
                        </p>
                    </div>
                </div>
                <div class="modal-actions">
                    <span id="editShareFromDetailBtn" class="button-icon-text-link save-btn" role="button" tabindex="0">
                        <i class="fas fa-edit"></i> Edit Share
                    </span>
                    <span id="deleteShareFromDetailBtn" class="button-icon-text-link delete-btn" role="button" tabindex="0">
                        <i class="fas fa-trash-alt"></i> Delete Share
                    </span>
                </div>
            </div>
        </section>

        <!-- Dividend Calculator Modal -->
        <section id="dividendCalculatorModal" class="modal">
            <div class="modal-content">
                <span class="close-button calc-close-button">&times;</span>
                <h2>Dividend Calculator</h2>
                <form>
                    <div class="form-group">
                        <label for="calcCurrentPrice">Current Share Price ($):</label>
                        <input type="number" id="calcCurrentPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="calcDividendAmount">Annual Dividend Amount (per share $):</label>
                        <input type="number" id="calcDividendAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="calcFrankingCredits">Franking Credits (%):</label>
                        <input type="number" id="calcFrankingCredits" step="0.01" min="0" max="100" value="100">
                    </div>
                    <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">0.00</span>%</p>
                    <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">0.00</span>%</p>
                    
                    <hr>
                    <div class="form-group">
                        <label for="investmentValueSelect">My Investment Value ($):</label>
                        <select id="investmentValueSelect">
                            <option value="1000">$1,000</option>
                            <option value="5000">$5,000</option>
                            <option value="10000">$10,000</option>
                            <option value="25000">$25,000</option>
                            <option value="50000">$50,000</option>
                            <option value="100000">$100,000</option>
                        </select>
                    </div>
                    <p><strong>Estimated Annual Dividend:</strong> $<span id="calcEstimatedDividend">0.00</span></p>
                </form>
            </div>
        </section>

        <!-- Generic Calculator Modal -->
        <section id="calculatorModal" class="modal">
            <div class="modal-content calculator-modal-content">
                <span class="close-button" onclick="closeModals()">&times;</span>
                <h2>Calculator</h2>
                <div class="calculator-display">
                    <div id="calculatorResult" class="calculator-result">0</div>
                    <div id="calculatorInput" class="calculator-input"></div>
                </div>
                <div class="calculator-buttons">
                    <button class="calc-btn clear">AC</button>
                    <button class="calc-btn backspace"><i class="fas fa-backspace"></i></button>
                    <button class="calc-btn operator">%</button>
                    <button class="calc-btn operator">/</button>
                    <button class="calc-btn number">7</button>
                    <button class="calc-btn number">8</button>
                    <button class="calc-btn number">9</button>
                    <button class="calc-btn operator">*</button>
                    <button class="calc-btn number">4</button>
                    <button class="calc-btn number">5</button>
                    <button class="calc-btn number">6</button>
                    <button class="calc-btn operator">-</button>
                    <button class="calc-btn number">1</button>
                    <button class="calc-btn number">2</button>
                    <button class="calc-btn number">3</button>
                    <button class="calc-btn operator">+</button>
                    <button class="calc-btn number zero">0</button>
                    <button class="calc-btn decimal">.</button>
                    <button class="calc-btn equals">=</button>
                </div>
            </div>
        </section>

        <!-- Custom Dialog Modal (Alert/Confirm) -->
        <section id="customDialogModal" class="modal">
            <div class="modal-content custom-dialog-content">
                <p id="customDialogMessage"></p>
                <div class="dialog-actions">
                    <span id="customDialogConfirmBtn" class="button-icon-text-link save-btn" role="button" tabindex="0">
                        <i class="fas fa-check-circle"></i> OK
                    </span>
                    <span id="customDialogCancelBtn" class="button-icon-text-link cancel-btn" role="button" tabindex="0">
                        <i class="fas fa-times-circle"></i> Cancel
                    </span>
                </div>
            </div>
        </section>

        <!-- Add Watchlist Modal -->
        <section id="addWatchlistModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModals()">&times;</span>
                <h2>Add New Watchlist</h2>
                <form id="addWatchlistForm">
                    <div class="form-group">
                        <label for="newWatchlistName">Watchlist Name:</label>
                        <input type="text" id="newWatchlistName" required>
                    </div>
                    <div class="form-actions">
                        <span id="saveWatchlistBtn" class="button-icon-text-link save-btn" role="button" tabindex="0">
                            <i class="fas fa-save"></i> Save Watchlist
                        </span>
                        <span id="cancelAddWatchlistBtn" class="button-icon-text-link cancel-btn" role="button" tabindex="0">
                            <i class="fas fa-times-circle"></i> Cancel
                        </span>
                    </div>
                </form>
            </div>
        </section>

        <!-- Manage Watchlist Modal (Edit/Delete) -->
        <section id="manageWatchlistModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModals()">&times;</span>
                <h2>Edit Watchlist</h2>
                <form id="manageWatchlistForm">
                    <div class="form-group">
                        <label for="editWatchlistName">Watchlist Name:</label>
                        <input type="text" id="editWatchlistName" required>
                    </div>
                    <div class="form-actions">
                        <span id="saveWatchlistNameBtn" class="button-icon-text-link save-btn" role="button" tabindex="0">
                            <i class="fas fa-save"></i> Save Name
                        </span>
                        <span id="deleteWatchlistInModalBtn" class="button-icon-text-link delete-btn" role="button" tabindex="0">
                            <i class="fas fa-trash-alt"></i> Delete Watchlist
                        </span>
                        <span id="cancelManageWatchlistBtn" class="button-icon-text-link cancel-btn" role="button" tabindex="0">
                            <i class="fas fa-times-circle"></i> Cancel
                        </span>
                    </div>
                </form>
            </div>
        </section>

        <!-- Share Context Menu (Right-click/Long-press) -->
        <div id="shareContextMenu" class="context-menu" style="display: none;">
            <span id="contextEditShareBtn" class="context-menu-item" role="button" tabindex="0">
                <i class="fas fa-edit"></i> Edit Share
            </span>
            <span id="contextDeleteShareBtn" class="context-menu-item" role="button" tabindex="0">
                <i class="fas fa-trash-alt"></i> Delete Share
            </span>
        </div>

        <!-- Scroll to Top Button -->
        <button id="scrollToTopBtn" title="Go to top">
            <i class="fas fa-arrow-up"></i>
        </button>

    </main>

    <footer class="fixed-footer">
        <div class="firebase-status">
            <span id="firebaseStatusText">Firebase Status: Initializing...</span>
            <div id="firebaseStatusLight" class="status-light grey"></div>
        </div>
        <div class="app-version">
            App Version: v150
        </div>
    </footer>

    <!-- Firebase SDK (Version 11.6.1) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script type="module">
        // This script block is for Firebase initialization and making objects globally available.
        // It should be placed BEFORE your main script.js file.

        // Global variables for Firebase instances
        let firebaseApp;
        let auth;
        let db;
        let firebaseInitialized = false;
        let currentAppId;

        // Firebase configuration will be provided by the environment
        // DO NOT HARDCODE YOUR API KEY HERE IN PRODUCTION
        // For local development, you might temporarily place it here, but remove before deployment.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                firebaseInitialized = true;
                console.log("[Firebase] Initialized successfully with provided config.");
            } catch (error) {
                console.error("[Firebase] Failed to initialize app with provided config:", error);
                const errorDiv = document.getElementById('firebaseInitError');
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                }
                firebaseInitialized = false;
            }
        } else {
            console.error("[Firebase] Configuration is missing or invalid (apiKey or projectId). Firebase will not initialize.");
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
            firebaseInitialized = false;
        }

        // Make Firebase objects globally accessible to script.js
        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete,
            writeBatch: writeBatch
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v82) script module loaded and DOMContentLoaded fired."); // Updated version number
        }); 
    </script>
    <!-- Linking to your separate script.js file -->
    <script src="script.js?v=150"></script> <!-- Updated to v150 -->
</body>
</html>
