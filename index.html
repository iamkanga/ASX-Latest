<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Watchlist App</title>
    <!-- Tailwind CSS CDN - Loaded first for base utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom CSS for specific styling and overrides - Loaded after Tailwind -->
    <link rel="stylesheet" href="style.css?v=49"> <!-- IMPORTANT: Ensure this version matches your style.css file -->
    <!-- Google Fonts for 'Inter' -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons - Used throughout the app for buttons and indicators -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* This inline style block is for critical initial hiding to prevent "flash of unstyled content" (FOUC)
           before the main script loads and applies classes for transitions.
           Most styling and transitions are handled in style.css. */
        body {
            font-family: 'Inter', sans-serif; /* Ensures Inter font is applied early */
        }
        /* All modals are initially hidden to prevent them from appearing on page load */
        .modal {
            display: none; /* Hidden by default, JavaScript will add 'open' class for visibility and transitions */
        }
        /* The .modal-overlay, .modal-content, and .app-sidebar transitions
           are primarily handled by style.css using the 'open' class. */
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Firebase SDKs - These MUST be loaded before your main script.js
         They provide the global 'window.firestoreDb', 'window.firebaseAuth', etc. -->
    <script type="module">
        // Import necessary Firebase modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
            signInAnonymously, signInWithCustomToken // signInWithCustomToken is used by the Canvas environment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc,
            deleteDoc, query, where, writeBatch, FieldValue, // FieldValue is needed for deleteField
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These variables (__app_id, __firebase_config, __initial_auth_token)
        // are automatically provided by the Canvas environment at runtime.
        // DO NOT hardcode your Firebase API keys or project IDs here.
        let appId = 'default-app-id';
        let firebaseConfig = {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Safely parse __firebase_config. If it's missing or invalid, use a fallback.
        if (typeof __app_id !== 'undefined') {
            appId = __app_id;
        } else {
            console.warn("Firebase Init: __app_id is not defined. Using default 'default-app-id'.");
        }

        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                if (!firebaseConfig.projectId) {
                    console.error("Firebase Init: Parsed firebaseConfig is missing 'projectId'. Using a placeholder.");
                    firebaseConfig.projectId = "placeholder-project-id"; // Provide a fallback
                }
            } catch (e) {
                console.error("Firebase Init: Error parsing __firebase_config. Using a minimal fallback.", e);
                firebaseConfig = { projectId: "parse-error-fallback", apiKey: "parse-error-fallback" };
            }
        } else {
            console.warn("Firebase Init: __firebase_config is not defined or is empty. Using a minimal fallback config.");
            firebaseConfig = { projectId: "no-config-provided", apiKey: "no-config-provided" };
        }

        console.log("Firebase Init: Attempting to initialize with config:", firebaseConfig);

        let app;
        let db;
        let auth;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase: Initialized successfully.");
        } catch (error) {
            console.error("Firebase: Initialization failed in index.html module script:", error);
            // IMPORTANT: Removed the document.body.innerHTML replacement here.
            // Let script.js handle UI disablement.
            return; // Stop this module script execution
        }

        // Make Firebase instances and core functions globally accessible to script.js
        window.firestoreDb = db;
        window.firebaseAuth = auth;
        window.getFirebaseAppId = () => appId; // Function to return the appId
        window.firestore = {
            collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc,
            query, where, writeBatch, FieldValue: FieldValue // Expose FieldValue for operations like deleteField
        };
        window.authFunctions = {
            signInWithPopup, GoogleAuthProviderInstance: new GoogleAuthProvider(), signOut, onAuthStateChanged,
            signInAnonymously, // Expose signInAnonymously for unauthenticated access
        };

        // Attempt authentication using the provided custom token or anonymously
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken)
                .then(() => console.log("Firebase: Signed in with custom token."))
                .catch(error => console.error("Firebase: Custom token sign-in failed:", error));
        } else {
            signInAnonymously(auth)
                .then(() => console.log("Firebase: Signed in anonymously."))
                .catch(error => console.error("Firebase: Anonymous sign-in failed:", error));
        }

        console.log("index.html (v48) script module loaded and DOMContentLoaded fired."); // Updated HTML version log
    </script>

    <!-- Main Header Section -->
    <header class="header">
        <div class="header-top-row">
            <!-- Hamburger Menu Button - Visible on all screen sizes -->
            <button id="hamburgerBtn" class="hamburger-btn" aria-label="Open menu">
                <i class="fas fa-bars"></i> <!-- Font Awesome hamburger icon -->
            </button>
            <!-- Main Title - Dynamically updated by script.js based on auth state -->
            <h1 id="mainTitle">Share Watchlist</h1>
            <!-- Add New Share Button in Header - Visible on all screen sizes -->
            <button id="addShareHeaderBtn" class="header-action-btn" aria-label="Add new share">
                <i class="fas fa-plus"></i> <!-- Font Awesome plus icon -->
            </button>
        </div>
        <!-- Watchlist and Sort Controls Row - Contains dropdowns and watchlist management buttons -->
        <div class="watchlist-controls-row">
            <div class="watchlist-group">
                <label for="watchlistSelect" class="text-gray-700 font-medium">Watchlist:</label>
                <select id="watchlistSelect" class="dropdown-large">
                    <option value="" disabled selected>Loading Watchlists...</option>
                </select>
                <!-- Add Watchlist Button -->
                <button id="addWatchlistBtn" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition-colors duration-200 text-sm" title="Add New Watchlist">
                    <i class="fas fa-plus"></i>
                </button>
                <!-- Manage Watchlist Button (Edit/Delete) -->
                <button id="editWatchlistBtn" class="bg-gray-300 text-gray-800 p-2 rounded-md hover:bg-gray-400 transition-colors duration-200 text-sm" title="Manage Current Watchlist">
                    <i class="fas fa-cog"></i> <!-- Cog icon for settings/manage -->
                </button>
            </div>
            <div class="sort-group">
                <label for="sortSelect" class="text-gray-700 font-medium">Sort by:</label>
                <select id="sortSelect" class="dropdown-large">
                    <option value="" disabled selected>Sort</option>
                    <option value="shareName-asc">Code (A-Z)</option>
                    <option value="shareName-desc">Code (Z-A)</option>
                    <option value="currentPrice-asc">Entered Price (Low-High)</option>
                    <option value="currentPrice-desc">Entered Price (High-Low)</option>
                    <option value="targetPrice-asc">Target Price (Low-High)</option>
                    <option value="targetPrice-desc">Target Price (High-Low)</option>
                    <option value="dividendAmount-asc">Dividend (Low-High)</option>
                    <option value="dividendAmount-desc">Dividend (High-Low)</option>
                    <option value="frankingCredits-asc">Franking (Low-High)</option>
                    <option value="frankingCredits-desc">Franking (High-Low)</option>
                    <option value="entryDate-asc">Entry Date (Oldest-Newest)</option>
                    <option value="entryDate-desc">Entry Date (Newest-Oldest)</option>
                </select>
            </div>
        </div>
        <!-- ASX Code Buttons Container - Dynamically populated by script.js -->
        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
            <!-- ASX code buttons will be dynamically loaded here by script.js -->
        </div>
    </header>

    <!-- App Sidebar - This slides in from the left on desktop and covers part of the screen on mobile -->
    <nav id="appSidebar" class="app-sidebar">
        <!-- Close button for the sidebar -->
        <button id="closeMenuBtn" class="close-menu-btn" aria-label="Close menu">&times;</button>
        <h3 class="text-lg font-semibold mb-3">Tools</h3>
        <div class="menu-buttons-group">
            <!-- Buttons for adding shares and calculators -->
            <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true">
                <i class="fas fa-plus-circle"></i> Add New Share
            </button>
            <button id="dividendCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                <i class="fas fa-calculator"></i> Dividend Calculator
            </button>
            <button id="standardCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                <i class="fas fa-calculator"></i> Standard Calculator
            </button>
        </div>

        <h3 class="text-lg font-semibold mb-3">Settings</h3>
        <div class="menu-buttons-group">
            <!-- Theme Toggle Button - Cycles through themes -->
            <button id="themeToggleBtn" class="menu-button-item" data-action-closes-menu="false">
                <i class="fas fa-palette"></i> Toggle Theme
            </button>
            <!-- Other settings can go here -->
        </div>

        <h3 class="text-lg font-semibold mb-3">Account</h3>
        <div class="menu-buttons-group">
            <!-- Google Authentication Button - Text changes based on login status -->
            <button id="googleAuthBtn" class="menu-button-item" data-action-closes-menu="false">
                <i class="fab fa-google"></i> Sign In
            </button>
        </div>
    </nav>
    <!-- Sidebar Overlay - Dims the background when sidebar is open and allows closing on click outside -->
    <div class="sidebar-overlay"></div>

    <!-- Main Content Area - Contains the share list and mobile cards -->
    <main class="container flex-grow">
        <!-- Loading Indicator - Shown while data is being fetched from Firebase -->
        <div id="loadingIndicator" class="loading" style="display: none;">
            <i class="fas fa-spinner fa-spin mr-2"></i> Loading shares...
        </div>

        <!-- Share List Section (Table for Desktop) - Dynamically populated by script.js -->
        <section class="share-list-section">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Entered Price</th>
                            <th>Target Price</th>
                            <th>Dividend & Yields</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share data rows will be dynamically loaded here by script.js -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Mobile Share Cards (for Mobile) - Dynamically populated by script.js -->
        <section id="mobileShareCards" class="mobile-share-cards">
            <!-- Mobile share cards will be dynamically loaded here by script.js -->
        </section>

        <!-- Scroll to Top Button (Mobile Only) -->
        <button id="scrollToTopBtn" class="hidden">
            <i class="fas fa-arrow-up"></i>
        </button>
    </main>

    <!-- Fixed Footer - Contains the Google Auth button for quick access -->
    <footer class="fixed-footer">
        <!-- This is a duplicate of the Google Auth button in the sidebar, for mobile accessibility -->
        <button id="googleAuthBtn" class="google-auth-btn">
            <i class="fab fa-google"></i> Sign In
        </button>
    </footer>

    <!-- MODALS SECTION - All modals are initially hidden and controlled by script.js -->

    <!-- Share Form Modal (Add/Edit Share) -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content">
            <button class="close-button form-close-button">&times;</button>
            <h2 id="formTitle">Add New Share</h2>
            <label for="shareName">ASX Code:</label>
            <input type="text" id="shareName" placeholder="e.g., CBA" maxlength="10">

            <label for="currentPrice">Entered Price ($):</label>
            <input type="number" id="currentPrice" placeholder="e.g., 105.20" step="0.01">

            <label for="targetPrice">Target Price ($):</label>
            <input type="number" id="targetPrice" placeholder="e.g., 110.00" step="0.01">

            <label for="dividendAmount">Dividend Amount ($ per share):</label>
            <input type="number" id="dividendAmount" placeholder="e.g., 2.50" step="0.001">

            <label for="frankingCredits">Franking Credits (%):</label>
            <input type="number" id="frankingCredits" placeholder="e.g., 100" step="0.1" min="0" max="100">

            <div id="commentsFormContainer" class="comments-form-container">
                <h3>Comments <button type="button" id="addCommentSectionBtn" class="add-section-btn">+</button></h3>
                <!-- Dynamic comment sections will be added here by script.js -->
            </div>

            <div class="form-action-buttons">
                <button type="button" id="cancelFormBtn" class="secondary-button">Cancel</button>
                <button type="button" id="deleteShareFromFormBtn" class="danger-button" style="display: none;">Delete</button>
                <button type="submit" id="saveShareBtn" class="primary-button">Save Share</button>
            </div>
        </div>
    </div>

    <!-- Share Detail Modal - Displays detailed information about a selected share -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h2 id="modalShareName" class="text-center">Share Name</h2>
            <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
            <!-- Entered Price - Date/Time is cleared by script.js -->
            <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span><span id="modalEnteredPriceDateTime" class="ghosted-text ml-2"></span></p>
            <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
            <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
            <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
            <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
            <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>

            <div id="modalCommentsContainer">
                <h3>Comments</h3>
                <!-- Comments will be dynamically loaded here by script.js -->
            </div>

            <div class="external-links-section">
                <h3>External Links</h3>
                <!-- External links to financial sites -->
                <a id="modalMarketIndexLink" href="#" target="_blank" rel="noopener noreferrer" class="external-link">
                    <i class="fas fa-external-link-alt"></i> MarketIndex.com.au
                </a>
                <a id="modalFoolLink" href="#" target="_blank" rel="noopener noreferrer" class="external-link">
                    <i class="fas fa-external-link-alt"></i> Fool.com.au
                </a>
                <a id="modalCommSecLink" href="#" target="_blank" rel="noopener noreferrer" class="external-link">
                    <i class="fas fa-external-link-alt"></i> CommSec.com.au
                </a>
                <!-- Ghosted text for CommSec login reminder -->
                <span id="commSecLoginMessage" class="ghosted-text block">Requires single CommSec login per session.</span>
            </div>

            <div class="modal-action-buttons">
                <button id="editShareFromDetailBtn" class="primary-button">Edit Share</button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <button class="close-button calc-close-button">&times;</button>
            <h2 class="text-center">Dividend Calculator</h2>

            <div class="calc-input-group">
                <label for="calcCurrentPrice">Share Price ($):</label>
                <input type="number" id="calcCurrentPrice" placeholder="e.g., 100.00" step="0.01">
            </div>

            <div class="calc-input-group">
                <label for="calcDividendAmount">Dividend Amount ($ per share):</label>
                <input type="number" id="calcDividendAmount" placeholder="e.g., 2.50" step="0.001">
            </div>

            <div class="calc-input-group">
                <label for="calcFrankingCredits">Franking Credits (%):</label>
                <input type="number" id="calcFrankingCredits" placeholder="e.g., 100" step="0.1" min="0" max="100">
            </div>

            <hr>

            <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
            <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">-</span></p>

            <hr>

            <div class="calc-input-group">
                <label for="investmentValueSelect">Investment Value ($):</label>
                <select id="investmentValueSelect">
                    <option value="1000">1,000</option>
                    <option value="5000">5,000</option>
                    <option value="10000" selected>10,000</option>
                    <option value="25000">25,000</option>
                    <option value="50000">50,000</option>
                    <option value="100000">100,000</option>
                </select>
            </div>
            <p><strong>Estimated Annual Dividend Income:</strong> <span id="calcEstimatedDividend">-</span></p>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <button class="close-button">&times;</button>
            <h2 class="text-center">Standard Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input"></div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">รท</button>
                <button class="calc-btn" data-value="7">7</button>
                <button class="calc-btn" data-value="8">8</button>
                <button class="calc-btn" data-value="9">9</button>
                <button class="calc-btn operator" data-action="multiply">ร</button>
                <button class="calc-btn" data-value="4">4</button>
                <button class="calc-btn" data-value="5">5</button>
                <button class="calc-btn" data-value="6">6</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                <button class="calc-btn" data-value="1">1</button>
                <button class="calc-btn" data-value="2">2</button>
                <button class="calc-btn" data-value="3">3</button>
                <button class="calc-btn operator" data-action="add">+</button>
                <button class="calc-btn zero" data-value="0">0</button>
                <button class="calc-btn" data-value=".">.</button>
                <button class="calc-btn equals" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div id="addWatchlistModal" class="modal">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h2 class="text-center">Add New Watchlist</h2>
            <label for="newWatchlistName">Watchlist Name:</label>
            <input type="text" id="newWatchlistName" placeholder="e.g., Tech Stocks" maxlength="50">
            <div class="form-action-buttons">
                <button type="button" id="cancelAddWatchlistBtn" class="secondary-button">Cancel</button>
                <button type="submit" id="saveWatchlistBtn" class="primary-button">Add Watchlist</button>
            </div>
        </div>
    </div>

    <!-- Manage Watchlist Modal (Edit/Delete) -->
    <div id="manageWatchlistModal" class="modal">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h2 class="text-center">Manage Watchlist</h2>
            <label for="editWatchlistName">Watchlist Name:</label>
            <input type="text" id="editWatchlistName" placeholder="e.g., My Watchlist" maxlength="50">
            <div class="form-action-buttons">
                <button type="button" id="cancelManageWatchlistBtn" class="secondary-button">Cancel</button>
                <button type="button" id="deleteWatchlistInModalBtn" class="danger-button">Delete Watchlist</button>
                <button type="submit" id="saveWatchlistNameBtn" class="primary-button">Save Name</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal (for custom alerts/confirms) -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <h3 id="customDialogMessage" class="text-lg font-medium text-center mb-4"></h3>
            <div class="custom-dialog-buttons">
                <button id="customDialogCancelBtn" class="secondary-button">Cancel</button>
                <button id="customDialogConfirmBtn" class="primary-button">OK</button>
            </div>
        </div>
    </div>

    <!-- Your main script.js - Loaded last to ensure all HTML elements are available -->
    <script src="script.js?v=111"></script> <!-- IMPORTANT: Ensure this version matches your script.js file -->
    <script>
        // Register service worker - This block is typically placed at the end of the body
        // to ensure the page content loads first.
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js', { scope: './' })
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
