<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASX Share Watchlist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=15">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#3b82f6">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <button id="hamburgerBtn" class="hamburger-btn" aria-label="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1>
            <button id="addShareHeaderBtn" class="add-share-btn" aria-label="Add new share">
                <i class="fas fa-plus"></i>
            </button>
        </header>

        <nav id="appSidebar" class="app-sidebar">
            <div class="sidebar-header">
                <h2>Menu</h2>
                <button id="closeMenuBtn" class="close-menu-btn" aria-label="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><button id="newShareBtn" class="menu-button-item"><i class="fas fa-plus-circle"></i> <span>Add New Share</span></button></li>
                <li><button id="addWatchlistBtn" class="menu-button-item"><i class="fas fa-list-ul"></i> <span>Add New Watchlist</span></button></li>
                <li><button id="editWatchlistBtn" class="menu-button-item"><i class="fas fa-edit"></i> <span>Manage Watchlist</span></button></li>
                <li><button id="standardCalcBtn" class="menu-button-item"><i class="fas fa-calculator"></i> <span>Standard Calculator</span></button></li>
                <li><button id="dividendCalcBtn" class="menu-button-item"><i class="fas fa-money-bill-wave"></i> <span>Dividend Calculator</span></button></li>
                <li><button id="exportWatchlistBtn" class="menu-button-item"><i class="fas fa-file-export"></i> <span>Export Watchlist (CSV)</span></button></li>
                <li class="theme-controls">
                    <button id="themeToggleBtn" class="menu-button-item" data-action-closes-menu="false"><i class="fas fa-sun"></i> <span>Light Theme</span></button>
                    <div class="color-theme-select-container">
                        <select id="colorThemeSelect" class="color-theme-select" data-action-closes-menu="false">
                            <option value="none">System Default</option>
                            <optgroup label="Bold Themes">
                                <option value="bold-1">Bold 1</option>
                                <option value="bold-2">Bold 2</option>
                                <option value="bold-3">Bold 3</option>
                                <option value="bold-4">Bold 4</option>
                                <option value="bold-5">Bold 5</option>
                                <option value="bold-6">Bold 6</option>
                                <option value="bold-7">Bold 7</option>
                                <option value="bold-8">Bold 8</option>
                                <option value="bold-9">Bold 9</option>
                                <option value="bold-10">Bold 10</option>
                            </optgroup>
                            <optgroup label="Subtle Themes">
                                <option value="subtle-1">Subtle 1</option>
                                <option value="subtle-2">Subtle 2</option>
                                <option value="subtle-3">Subtle 3</option>
                                <option value="subtle-4">Subtle 4</option>
                                <option value="subtle-5">Subtle 5</option>
                                <option value="subtle-6">Subtle 6</option>
                                <option value="subtle-7">Subtle 7</option>
                                <option value="subtle-8">Subtle 8</option>
                                <option value="subtle-9">Subtle 9</option>
                                <option value="subtle-10">Subtle 10</option>
                            </optgroup>
                        </select>
                        <button id="revertToDefaultThemeBtn" class="revert-theme-btn" aria-label="Revert to default theme" data-action-closes-menu="false">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </li>
                <li><button id="logoutBtn" class="menu-button-item"><i class="fas fa-sign-out-alt"></i> <span>Log Out</span></button></li>
            </ul>
            <div class="sidebar-footer">
                <button id="googleAuthBtn" class="google-auth-btn">Sign In with Google</button>
            </div>
        </nav>
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <main class="app-main">
            <div class="controls-container">
                <div class="watchlist-sort-group">
                    <div class="select-wrapper">
                        <select id="watchlistSelect" class="select-control">
                            <option value="" disabled selected>Select Watchlist</option>
                            <!-- Watchlist options will be populated by JavaScript -->
                        </select>
                        <i class="fas fa-chevron-down select-arrow"></i>
                    </div>
                    <div class="select-wrapper">
                        <select id="sortSelect" class="select-control">
                            <option value="">Sort By</option>
                            <option value="shareName-asc">Share Name (A-Z)</option>
                            <option value="shareName-desc">Share Name (Z-A)</option>
                            <option value="entryDate-desc">Entry Date (Newest)</option>
                            <option value="entryDate-asc">Entry Date (Oldest)</option>
                            <option value="dividendAmount-desc">Dividend Amount (High to Low)</option>
                            <option value="dividendAmount-asc">Dividend Amount (Low to High)</option>
                        </select>
                        <i class="fas fa-chevron-down select-arrow"></i>
                    </div>
                </div>
                <div id="asxCodeButtonsContainer" class="asx-code-buttons">
                    <!-- ASX code buttons will be populated by JavaScript -->
                </div>
            </div>

            <div id="loadingIndicator" class="loading-indicator">
                <div class="spinner"></div>
                <p>Loading data...</p>
            </div>

            <div id="firebaseInitError" class="error-message" style="display: none;">
                <p>Firebase initialization failed. Please check your console for errors and ensure your Firebase configuration is correct.</p>
                <p>If you are running this app locally, ensure `__firebase_config` is properly defined or replace it with your direct config.</p>
            </div>

            <div class="table-container">
                <table id="shareTable" class="share-table">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Current Price</th>
                            <th>Target Price</th>
                            <th>Dividends (Yield)</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody class="share-table-body">
                        <!-- Share data will be loaded here by JavaScript -->
                        <tr><td colspan="5" class="no-shares-message">No shares added yet. Click the "+" button to add one!</td></tr>
                    </tbody>
                </table>
            </div>

            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be loaded here by JavaScript -->
                <div class="no-shares-message">No shares added yet. Click the "+" button to add one!</div>
            </div>
            
            <button id="scrollToTopBtn" class="scroll-to-top-btn" aria-label="Scroll to top">
                <i class="fas fa-arrow-up"></i>
            </button>
        </main>
    </div>

    <!-- Share Form Modal -->
    <div id="shareFormSection" class="modal form-modal">
        <div class="modal-content">
            <span class="form-close-button">&times;</span>
            <h2 id="formTitle">Add New Share</h2>
            <form id="shareForm">
                <div class="form-group">
                    <label for="shareName">Share Code (e.g., CBA, BHP)</label>
                    <input type="text" id="shareName" required placeholder="e.g., CBA">
                </div>
                <div class="form-group">
                    <label for="currentPrice">Current Price ($)</label>
                    <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 100.50">
                </div>
                <div class="form-group">
                    <label for="targetPrice">Target Price ($)</label>
                    <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 110.00">
                </div>
                <div class="form-group">
                    <label for="dividendAmount">Annual Dividend Amount ($)</label>
                    <input type="number" id="dividendAmount" step="0.01" placeholder="e.g., 3.50">
                </div>
                <div class="form-group">
                    <label for="frankingCredits">Franking Credits (%)</label>
                    <input type="number" id="frankingCredits" step="0.01" min="0" max="100" value="100" placeholder="e.g., 100">
                </div>
                
                <div id="commentsFormContainer" class="comments-form-container">
                    <!-- Comment sections will be added here by JavaScript -->
                    <div class="comment-section">
                        <div class="comment-section-header">
                            <input type="text" class="comment-title-input" placeholder="Comment Title">
                            <span class="comment-delete-btn"><i class="fas fa-trash-alt"></i></span>
                        </div>
                        <textarea class="comment-text-input" placeholder="Your comment here..."></textarea>
                    </div>
                </div>
                <button type="button" id="addCommentSectionBtn" class="add-comment-btn"><i class="fas fa-comment-medical"></i> Add Comment Section</button>

                <div class="form-actions">
                    <button type="button" id="deleteShareBtn" class="delete-btn hidden"><i class="fas fa-trash"></i> Delete</button>
                    <button type="button" id="cancelFormBtn" class="cancel-btn">Cancel</button>
                    <button type="submit" id="saveShareBtn" class="save-btn">Save Share</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Share Detail Modal -->
    <div id="shareDetailModal" class="modal detail-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalShareName">Share Name</h2>
            <div class="detail-grid">
                <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span></p>
                <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
                <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>
            </div>
            <div class="external-links">
                <h3>External Links</h3>
                <a id="modalNewsLink" href="#" target="_blank" rel="noopener noreferrer"><i class="fas fa-newspaper"></i> News</a>
                <a id="modalMarketIndexLink" href="#" target="_blank" rel="noopener noreferrer"><i class="fas fa-chart-line"></i> Market Index</a>
                <a id="modalFoolLink" href="#" target="_blank" rel="noopener noreferrer"><i class="fas fa-hat-wizard"></i> Motley Fool</a>
                <a id="modalCommSecLink" href="#" target="_blank" rel="noopener noreferrer"><i class="fas fa-building"></i> CommSec</a>
                <p id="commSecLoginMessage" class="ghosted-text">Note: CommSec link may require login.</p>
            </div>
            <div id="modalCommentsContainer" class="modal-comments-container">
                <!-- Comments will be loaded here by JavaScript -->
                <h3>Comments</h3>
                <p class="ghosted-text">No comments for this share.</p>
            </div>
            <div class="modal-actions">
                <button id="deleteShareFromDetailBtn" class="delete-btn"><i class="fas fa-trash"></i> Delete</button>
                <button id="editShareFromDetailBtn" class="edit-btn"><i class="fas fa-edit"></i> Edit</button>
            </div>
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div id="addWatchlistModal" class="modal add-watchlist-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Add New Watchlist</h2>
            <div class="form-group">
                <label for="newWatchlistName">Watchlist Name</label>
                <input type="text" id="newWatchlistName" required placeholder="e.g., Tech Stocks, Dividends">
            </div>
            <div class="modal-actions">
                <button id="cancelAddWatchlistBtn" class="cancel-btn">Cancel</button>
                <button id="saveWatchlistBtn" class="save-btn">Save Watchlist</button>
            </div>
        </div>
    </div>

    <!-- Manage Watchlist Modal -->
    <div id="manageWatchlistModal" class="modal manage-watchlist-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Manage Watchlist</h2>
            <div class="form-group">
                <label for="editWatchlistName">Watchlist Name</label>
                <input type="text" id="editWatchlistName" required>
            </div>
            <div class="modal-actions">
                <button id="deleteWatchlistInModalBtn" class="delete-btn"><i class="fas fa-trash"></i> Delete</button>
                <button id="cancelManageWatchlistBtn" class="cancel-btn">Cancel</button>
                <button id="saveWatchlistNameBtn" class="save-btn">Save Name</button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal calculator-modal">
        <div class="modal-content">
            <span class="calc-close-button">&times;</span>
            <h2>Dividend Calculator</h2>
            <div class="calc-form-group">
                <label for="calcCurrentPrice">Current Share Price ($)</label>
                <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 100.50">
            </div>
            <div class="calc-form-group">
                <label for="calcDividendAmount">Annual Dividend Amount ($)</label>
                <input type="number" id="calcDividendAmount" step="0.01" placeholder="e.g., 3.50">
            </div>
            <div class="calc-form-group">
                <label for="calcFrankingCredits">Franking Credits (%)</label>
                <input type="number" id="calcFrankingCredits" step="0.01" min="0" max="100" value="100" placeholder="e.g., 100">
            </div>
            <div class="calc-results">
                <p>Unfranked Yield: <span id="calcUnfrankedYield">-</span></p>
                <p>Franked Yield: <span id="calcFrankedYield">-</span></p>
            </div>
            <div class="calc-form-group">
                <label for="investmentValueSelect">Estimated Investment Value ($)</label>
                <select id="investmentValueSelect">
                    <option value="0">None</option>
                    <option value="1000">1,000</option>
                    <option value="5000">5,000</option>
                    <option value="10000" selected>10,000</option>
                    <option value="25000">25,000</option>
                    <option value="50000">50,000</option>
                    <option value="100000">100,000</option>
                </select>
            </div>
            <div class="calc-results">
                <p>Estimated Annual Dividend: <span id="calcEstimatedDividend">-</span></p>
            </div>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal standard-calculator-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="input"></div>
                <div id="calculatorResult" class="result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn function" data-action="clear">AC</button>
                <button class="calc-btn function" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">รท</button>
                <button class="calc-btn number" data-value="7">7</button>
                <button class="calc-btn number" data-value="8">8</button>
                <button class="calc-btn number" data-value="9">9</button>
                <button class="calc-btn operator" data-action="multiply">ร</button>
                <button class="calc-btn number" data-value="4">4</button>
                <button class="calc-btn number" data-value="5">5</button>
                <button class="calc-btn number" data-value="6">6</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                <button class="calc-btn number" data-value="1">1</button>
                <button class="calc-btn number" data-value="2">2</button>
                <button class="calc-btn number" data-value="3">3</button>
                <button class="calc-btn operator" data-action="add">+</button>
                <button class="calc-btn number zero" data-value="0">0</button>
                <button class="calc-btn number" data-value=".">.</button>
                <button class="calc-btn operator" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="shareContextMenu" class="context-menu">
        <button id="contextEditShareBtn" class="context-menu-item"><i class="fas fa-edit"></i> Edit Share</button>
        <button id="contextDeleteShareBtn" class="context-menu-item delete"><i class="fas fa-trash"></i> Delete Share</button>
    </div>

    <!-- Custom Dialog Modal -->
    <div id="customDialogModal" class="modal custom-dialog-modal">
        <div class="modal-content">
            <p id="customDialogMessage"></p>
            <div class="dialog-actions">
                <button id="customDialogCancelBtn" class="cancel-btn">No</button>
                <button id="customDialogConfirmBtn" class="save-btn">Yes</button>
            </div>
        </div>
    </div>

    <!-- Firebase Initialization Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signOut, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration - YOUR PROJECT'S ACTUAL CONFIG
        // This has been directly embedded from the details you provided.
        const firebaseConfig = {
          apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw",
          authDomain: "asx-watchlist-app.firebaseapp.com",
          projectId: "asx-watchlist-app",
          storageBucket: "asx-watchlist-app.firebasestorage.app",
          messagingSenderId: "671024168765",
          appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54",
          measurementId: "G-J24BTJ34D2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose Firebase objects globally for script.js
        window.firestoreDb = db;
        window.firebaseAuth = auth;
        window.firestore = {
            collection, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, writeBatch
        };
        window.authFunctions = {
            signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProviderInstance: new GoogleAuthProvider(), signOut, signInWithPopup
        };
        // This function now correctly returns the projectId from the embedded config
        window.getFirebaseAppId = () => {
            return firebaseConfig.projectId;
        };
        window.firebaseApp = app; // Make the app instance available for debugging in script.js

        document.addEventListener('DOMContentLoaded', function() {
            console.log("index.html (v85) script module loaded and DOMContentLoaded fired.");
            // Register service worker
            if ('serviceWorker' in navigator) {
                // IMPORTANT: The path below MUST be correct for your GitHub Pages deployment.
                // It should be '/your-repository-name/service-worker.js'
                // For your setup, it should be '/ASX-Latest/service-worker.js'
                navigator.serviceWorker.register('/ASX-Latest/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
        });
    </script>
    
    <!-- Main Application Logic -->
    <script src="script.js?v=154"></script> <!-- Ensure this points to your v154 script.js -->
</body>
</html>
