<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Tracker</title>
    <!-- Favicon: Eggplant emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÜ</text></svg>">

    <!-- Linking to your separate style.css file -->
    <link rel="stylesheet" href="style.css?v=82"> <!-- Updated to v82 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-top-row">
            <!-- Hamburger/Sidebar Toggle Button - NOW ON LEFT -->
            <button id="hamburgerBtn" class="hamburger-btn header-action-btn-left">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1>
            <!-- Add Share Button - NOW ON RIGHT -->
            <button id="addShareHeaderBtn" class="add-share-btn header-action-btn-right is-disabled-icon">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <div class="header-bottom-row">
            <div class="watchlist-controls-row">
                <div class="watchlist-group">
                    <label for="watchlistSelect">Watchlist:</label>
                    <select id="watchlistSelect" class="dropdown-large" disabled>
                        <!-- Options populated by JavaScript -->
                    </select>
                    <button id="addWatchlistBtn" class="icon-button" title="Add New Watchlist"><i class="fas fa-plus-circle"></i></button>
                    <button id="editWatchlistBtn" class="icon-button" title="Manage Selected Watchlist"><i class="fas fa-edit"></i></button>
                </div>
                <div class="sort-group">
                    <label for="sortSelect">Sort by:</label>
                    <select id="sortSelect" class="dropdown-small" disabled>
                        <option value="entryDate-desc">Date (Newest)</option>
                        <option value="entryDate-asc">Date (Oldest)</option>
                        <option value="shareName-asc">Code (A-Z)</option>
                        <option value="shareName-desc">Code (Z-A)</option>
                        <option value="dividendAmount-desc">Dividend (High to Low)</option>
                        <option value="dividendAmount-asc">Dividend (Low to High)</option>
                    </select>
                </div>
            </div>
            <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
                <!-- ASX Code buttons will be dynamically generated here -->
            </div>
        </div>
    </header>

    <main>
        <div id="loadingIndicator" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <div id="firebaseInitError" class="error-message-banner">
            <p>Firebase initialization failed. Some features may not be available. Please try refreshing the page.</p>
        </div>

        <section id="shareListSection">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Entered Price</th>
                            <th>Target Price</th>
                            <th>Dividends (Yield)</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share data will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be populated here by JavaScript -->
            </div>
        </section>
    </main>

    <footer class="fixed-footer">
        <button id="standardCalcBtn" class="footer-button is-disabled-icon"><i class="fas fa-calculator"></i> <span>Calculator</span></button>
        <button id="dividendCalcBtn" class="footer-button is-disabled-icon"><i class="fas fa-percentage"></i> <span>Dividend Calc</span></button>
        <button id="exportWatchlistBtn" class="footer-button is-disabled-icon"><i class="fas fa-file-csv"></i> <span>Export CSV</span></button>
    </footer>

    <!-- Sidebar Navigation -->
    <div id="appSidebar" class="app-sidebar">
        <div class="sidebar-header">
            <h2>Menu</h2>
            <button id="closeMenuBtn" class="close-button"><i class="fas fa-times"></i></button>
        </div>
        <nav class="sidebar-nav">
            <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-plus-square"></i> New Share</button>
            <button id="standardCalcBtnSidebar" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-calculator"></i> Standard Calculator</button>
            <button id="dividendCalcBtnSidebar" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-percentage"></i> Dividend Calculator</button>
            <button id="addWatchlistBtnSidebar" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-plus-circle"></i> Add Watchlist</button>
            <button id="editWatchlistBtnSidebar" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-edit"></i> Manage Watchlists</button>
            <button id="exportWatchlistBtnSidebar" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-file-csv"></i> Export Watchlist</button>
            <button id="themeToggleBtn" class="menu-button-item"><i class="fas fa-moon"></i> <span>Dark Theme</span></button>
            <div class="menu-item-dropdown-container">
                <label for="colorThemeSelect" class="menu-button-item"><i class="fas fa-palette"></i> Custom Themes</label>
                <select id="colorThemeSelect" class="menu-item-dropdown">
                    <option value="none">No Custom Theme</option>
                    <option value="bold-1">Bold Theme 1</option>
                    <option value="bold-2">Bold Theme 2</option>
                    <option value="subtle-1">Subtle Theme 1</option>
                </select>
            </div>
            <button id="revertToDefaultThemeBtn" class="menu-button-item" data-action-closes-menu="true"><i class="fas fa-undo"></i> Revert to Default Theme</button>
        </nav>
        <div class="sidebar-footer">
            <button id="googleAuthBtn" class="google-auth-btn">Sign In</button>
            <button id="logoutBtn" class="icon-button logout-btn is-disabled-icon" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            <span id="userIdDisplay" class="user-id-display">Not Signed In</span>
        </div>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Share Form Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content">
            <button class="close-button"><i class="fas fa-times"></i></button>
            <h2 id="formTitle">Add New Share</h2>
            <form id="shareForm">
                <div class="form-group">
                    <label for="shareName">Share Code (e.g., CBA):</label>
                    <input type="text" id="shareName" required>
                </div>
                <div class="form-group">
                    <label for="currentPrice">Entered Price ($):</label>
                    <input type="number" id="currentPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="targetPrice">Target Price ($):</label>
                    <input type="number" id="targetPrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="dividendAmount">Annual Dividend Amount ($):</label>
                    <input type="number" id="dividendAmount" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="frankingCredits">Franking Credits (%):</label>
                    <input type="number" id="frankingCredits" step="0.01" min="0" max="100">
                </div>

                <h3>Comments <button type="button" id="addCommentSectionBtn" class="icon-button"><i class="fas fa-plus-circle"></i></button></h3>
                <div id="commentsFormContainer">
                    <!-- Comment sections will be dynamically added here -->
                </div>

                <div class="form-actions">
                    <button type="button" id="saveShareBtn" class="button-primary">Save Share</button>
                    <button type="button" id="cancelFormBtn" class="button-secondary">Cancel</button>
                    <button type="button" id="deleteShareBtn" class="button-danger hidden">Delete Share</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Share Detail Modal -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <button class="close-button"><i class="fas fa-times"></i></button>
            <h2 id="modalShareName"></h2>
            <div class="detail-grid">
                <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                <p><strong>Entered Price:</strong> <span id="modalEnteredPrice"></span></p>
                <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                <p><strong>Annual Dividend:</strong> <span id="modalDividendAmount"></span></p>
                <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
                <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>
            </div>

            <h3>External Links</h3>
            <div class="external-links">
                <a id="modalNewsLink" href="#" target="_blank" rel="noopener noreferrer" class="button-link">Google News</a>
                <a id="modalMarketIndexLink" href="#" target="_blank" rel="noopener noreferrer" class="button-link">Market Index</a>
                <a id="modalFoolLink" href="#" target="_blank" rel="noopener noreferrer" class="button-link">Motley Fool</a>
                <a id="modalCommSecLink" href="#" target="_blank" rel="noopener noreferrer" class="button-link">CommSec</a>
            </div>

            <h3>Comments</h3>
            <div id="modalCommentsContainer" class="modal-comments-container">
                <!-- Comments will be displayed here -->
            </div>

            <div class="modal-actions">
                <button id="editShareFromDetailBtn" class="button-primary">Edit Share</button>
                <button id="deleteShareFromDetailBtn" class="button-danger">Delete Share</button>
            </div>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <button class="close-button"><i class="fas fa-times"></i></button>
            <h2>Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input">0</div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn function-btn" data-action="clear">C</button>
                <button class="calc-btn function-btn" data-action="percentage">%</button>
                <button class="calc-btn operator-btn" data-action="divide">√∑</button>
                <button class="calc-btn operator-btn" data-action="multiply">√ó</button>

                <button class="calc-btn number-btn" data-value="7">7</button>
                <button class="calc-btn number-btn" data-value="8">8</button>
                <button class="calc-btn number-btn" data-value="9">9</button>
                <button class="calc-btn operator-btn" data-action="subtract">-</button>

                <button class="calc-btn number-btn" data-value="4">4</button>
                <button class="calc-btn number-btn" data-value="5">5</button>
                <button class="calc-btn number-btn" data-value="6">6</button>
                <button class="calc-btn operator-btn" data-action="add">+</button>

                <button class="calc-btn number-btn" data-value="1">1</button>
                <button class="calc-btn number-btn" data-value="2">2</button>
                <button class="calc-btn number-btn" data-value="3">3</button>
                <button class="calc-btn number-btn zero-btn" data-value="0">0</button>
                <button class="calc-btn number-btn" data-value=".">.</button>
                <button class="calc-btn equals-btn" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content">
            <button class="close-button"><i class="fas fa-times"></i></button>
            <h2>Dividend Calculator</h2>
            <div class="form-group">
                <label for="calcCurrentPrice">Current Share Price ($):</label>
                <input type="number" id="calcCurrentPrice" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="calcDividendAmount">Annual Dividend Amount ($):</label>
                <input type="number" id="calcDividendAmount" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="calcFrankingCredits">Franking Credits (%):</label>
                <input type="number" id="calcFrankingCredits" step="0.01" min="0" max="100">
            </div>
            <div class="form-group">
                <label for="investmentValueSelect">Investment Value ($):</label>
                <select id="investmentValueSelect">
                    <option value="1000">$1,000</option>
                    <option value="5000">$5,000</option>
                    <option value="10000">$10,000</option>
                    <option value="25000">$25,000</option>
                    <option value="50000">$50,000</option>
                    <option value="100000">$100,000</option>
                </select>
            </div>
            <div class="results-grid">
                <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">N/A</span></p>
                <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">N/A</span></p>
                <p><strong>Estimated Annual Dividend:</strong> <span id="calcEstimatedDividend">N/A</span></p>
            </div>
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div id="addWatchlistModal" class="modal">
        <div class="modal-content">
            <button class="close-button"><i class="fas fa-times"></i></button>
            <h2>Add New Watchlist</h2>
            <div class="form-group">
                <label for="newWatchlistName">Watchlist Name:</label>
                <input type="text" id="newWatchlistName" placeholder="e.g., Tech Stocks, My Portfolio">
            </div>
            <div class="form-actions">
                <button type="button" id="saveWatchlistBtn" class="button-primary">Create Watchlist</button>
                <button type="button" id="cancelAddWatchlistBtn" class="button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Watchlist Modal -->
    <div id="manageWatchlistModal" class="modal">
        <div class="modal-content">
            <button class="close-button"><i class="fas fa-times"></i></button>
            <h2>Manage Watchlist</h2>
            <div class="form-group">
                <label for="editWatchlistName">Watchlist Name:</label>
                <input type="text" id="editWatchlistName">
            </div>
            <div class="form-actions">
                <button type="button" id="saveWatchlistNameBtn" class="button-primary">Save Name</button>
                <button type="button" id="deleteWatchlistInModalBtn" class="button-danger">Delete Watchlist</button>
                <button type="button" id="cancelManageWatchlistBtn" class="button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal (for alerts, confirms) -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content custom-dialog-content">
            <p id="customDialogMessage"></p>
            <div class="dialog-actions">
                <button id="customDialogConfirmBtn" class="button-primary">OK</button>
                <button id="customDialogCancelBtn" class="button-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scrollToTopBtn" class="scroll-to-top-btn" title="Scroll to top"><i class="fas fa-arrow-up"></i></button>

    <!-- Context Menu for Shares (Right-click/Long-press) -->
    <div id="shareContextMenu" class="context-menu">
        <button id="contextEditShareBtn"><i class="fas fa-edit"></i> Edit Share</button>
        <button id="contextDeleteShareBtn"><i class="fas fa-trash-alt"></i> Delete Share</button>
    </div>

    <!-- Firebase SDK (Version 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInAnonymously, signInWithCustomToken, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, FieldValue, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseInitialized = false;
        let db = null;
        let auth = null;
        let currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        try {
            // Use the global __firebase_config variable provided by the Canvas environment
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseInitialized = true;
                console.log("Firebase: Initialized successfully with config.");
            } else {
                console.error("Firebase: __firebase_config global variable is not defined or is null. Cannot initialize Firebase.");
                const errorDiv = document.getElementById('firebaseInitError');
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                }
            }
        } catch (e) {
            console.error("Firebase: Error initializing Firebase:", e);
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
            firebaseInitialized = false;
        }

        // Expose Firebase objects and functions globally for script.js
        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestoreFunctions = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            serverTimestamp: FieldValue.serverTimestamp, // Expose serverTimestamp
            deleteField: FieldValue.delete,
            writeBatch: writeBatch
        } : null;

        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        // Dispatch a custom event when Firebase globals are ready AND DOM is loaded.
        // This ensures script.js can rely on these globals being set.
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html (v99) script module loaded and DOMContentLoaded fired."); // Updated version number
            // Wait for Firebase to be initialized before dispatching the event
            // This is a simple check; a more robust solution might involve promises.
            if (window.firestoreDb && window.firebaseAuth) {
                window.firebaseGlobalsReady = true;
                console.log("index.html: window.firebaseGlobalsReady set to true");
                console.log("index.html: typeof window.firestoreFunctions.serverTimestamp at init:", typeof window.firestoreFunctions.serverTimestamp);
                const event = new Event('firebaseGlobalsAndDOMReady');
                document.dispatchEvent(event);
            } else {
                console.error("index.html: Firebase globals not ready after DOMContentLoaded.");
            }
        });
    </script>
    <!-- Linking to your separate script.js file -->
    <script src="script.js?v=170"></script> <!-- Updated to v170 -->
</body>
</html>
