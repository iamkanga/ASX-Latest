<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Watchlist</title>
    <!-- Favicon -->
    <link rel="icon" href="Favicn.png" type="image/png">

    <!-- Linking to your separate style.css file -->
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="./manifest.json">
</head>
<body>
    <!-- Splash Screen Container -->
    <div id="splashScreen" class="splash-screen">
        <img id="splashKangarooIcon" src="Kangaicon.jpg" alt="Kangaroo App Icon" class="splash-icon">
        <!-- The sign-in button on the splash screen -->
        <button id="splashSignInBtn" class="google-auth-btn">Google Sign In</button>
    </div>

    <header id="appHeader" class="app-hidden">
        <div class="header-top-row">
            <!-- Hamburger/Sidebar Toggle Button -->
            <button id="hamburgerBtn" class="hamburger-btn header-action-btn-left" aria-label="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="mainTitle">Share Watchlist</h1>
            <!-- Header Action Buttons -->
            <div class="header-action-group header-action-btn-right">
                <button id="addShareHeaderBtn" class="header-action-btn" aria-label="Add new share">
                    <i class="fas fa-plus-circle"></i>
                </button>
                <button id="refreshLivePricesBtn" class="header-action-btn" aria-label="Refresh live prices">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div class="watchlist-controls-row">
            <div class="watchlist-group">
                <label for="watchlistSelect" class="sr-only">Select Watchlist</label>
                <select id="watchlistSelect" class="dropdown-large">
                    <option value="" disabled selected>Watch List</option>
                </select>
            </div>
            <div class="sort-group">
                <label for="sortSelect" class="sr-only">Sort List</label>
                <select id="sortSelect" class="dropdown-large">
                    <option value="" disabled selected>Sort List</option>
                </select>
            </div>
            <!-- NEW: Toggle Compact View Button -->
            <button id="toggleCompactViewBtn" class="asx-code-btn" aria-label="Toggle compact view">
                <i class="fas fa-th-large"></i> View
            </button>
        </div>
        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
            <!-- ASX code buttons will be dynamically added here -->
        </div>
    </header>

    <main class="container">
        <div id="loadingIndicator" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading data...</p>
        </div>
        <div id="firebaseInitError" class="error-message" style="display: none;">
            <p>Error initializing Firebase. Please check your internet connection or try again later.</p>
            <p>If the problem persists, contact support.</p>
        </div>

        <section class="share-list-section">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Live Price</th>
                            <th>Entered Price</th>
                            <th>Target</th>
                            <th>Dividends</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Share rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                <!-- Mobile share cards will be dynamically added here -->
            </div>
        </section>
    </main>

    <footer class="fixed-footer">
        <!-- Footer content if any -->
    </footer>

    <!-- Modals -->

    <!-- Share Form Modal -->
    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content">
            <div class="modal-header-with-icon">
                <h2 id="formTitle">Add New Share</h2>
                <div class="modal-header-action-group">
                    <button id="saveShareBtn" class="modal-action-icon" aria-label="Save share">
                        <i class="fas fa-save"></i>
                    </button>
                    <button id="deleteShareBtn" class="modal-action-icon danger hidden" aria-label="Delete share">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="close-button form-close-button" aria-label="Close form">&times;</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <label for="shareName">ASX Code:</label>
                <input type="text" id="shareName" placeholder="e.g., CBA" required>

                <label for="currentPrice">Entered Price ($):</label>
                <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 100.50">

                <label for="targetPrice">Target Price ($):</label>
                <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 105.00">

                <label for="dividendAmount">Dividend Amount ($ per share):</label>
                <input type="number" id="dividendAmount" step="0.001" placeholder="e.g., 2.500">

                <label for="frankingCredits">Franking Credits (%):</label>
                <input type="number" id="frankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 100.0">

                <label for="shareWatchlistSelect">Assign to Watchlist:</label>
                <select id="shareWatchlistSelect" class="dropdown-large">
                    <option value="" disabled selected>Select a Watchlist</option>
                </select>

                <div class="comments-form-container">
                    <h3>Comments <button id="addCommentSectionBtn" class="add-section-icon" aria-label="Add comment section"><i class="fas fa-plus"></i></button></h3>
                    <div id="dynamicCommentsArea">
                        <!-- Dynamic comment sections will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Details Modal -->
    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2 id="modalShareName"></h2>
                <div class="modal-header-action-group">
                    <button id="editShareFromDetailBtn" class="modal-action-icon" aria-label="Edit share">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button id="deleteShareFromDetailBtn" class="modal-action-icon danger" aria-label="Delete share">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="close-button" aria-label="Close details">&times;</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <div class="live-price-display-section">
                    <!-- Live price, change, 52-week high/low, P/E will be dynamically inserted here -->
                </div>
                <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>
                
                <div class="modal-comments-sections">
                    <h3>Comments</h3>
                    <div id="modalCommentsContainer">
                        <!-- Comments will be dynamically inserted here -->
                    </div>
                </div>

                <div class="external-links-section">
                    <h3>External Links</h3>
                    <a id="modalNewsLink" href="#" target="_blank" rel="noopener noreferrer" class="external-link">
                        <i class="fas fa-newspaper"></i> <span>View News</span>
                    </a>
                    <a id="modalMarketIndexLink" href="#" target="_blank" rel="noopener noreferrer" class="external-link">
                        <i class="fas fa-chart-line"></i> <span>View on MarketIndex.com.au</span>
                    </a>
                    <a id="modalFoolLink" href="https://www.fool.com.au/" target="_blank" rel="noopener noreferrer" class="external-link">
                        <i class="fas fa-lightbulb"></i> <span>Visit Fool.com.au</span>
                    </a>
                    <a id="modalCommSecLink" href="https://www.commsec.com.au/markets/prices.html" target="_blank" rel="noopener noreferrer" class="external-link">
                        <i class="fas fa-external-link-alt"></i> <span>CommSec Live Prices</span>
                    </a>
                    <p id="commSecLoginMessage" class="ghosted-text commsec-message">
                        CommSec live prices require a CommSec login.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dividend Calculator Modal -->
    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <button class="close-button calc-close-button" aria-label="Close calculator">&times;</button>
            <h2>Dividend Calculator</h2>
            <div class="modal-body-scrollable">
                <div class="calc-input-group">
                    <label for="calcCurrentPrice">Current Share Price ($):</label>
                    <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 100.50">
                </div>
                <div class="calc-input-group">
                    <label for="calcDividendAmount">Dividend Amount ($ per share):</label>
                    <input type="number" id="calcDividendAmount" step="0.001" placeholder="e.g., 2.500">
                </div>
                <div class="calc-input-group">
                    <label for="calcFrankingCredits">Franking Credits (%):</label>
                    <input type="number" id="calcFrankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 100.0">
                </div>

                <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield">-</span></p>
                <p><strong>Franked Yield:</strong> <span id="calcFrankedYield">-</span></p>

                <hr style="margin: 20px 0; border-color: var(--border-color);">

                <div class="calc-input-group">
                    <label for="investmentValueSelect">Investment Value ($):</label>
                    <select id="investmentValueSelect" class="dropdown-large">
                        <option value="1000">1,000</option>
                        <option value="5000">5,000</option>
                        <option value="10000" selected>10,000</option>
                        <option value="25000">25,000</option>
                        <option value="50000">50,000</option>
                        <option value="100000">100,000</option>
                        <option value="250000">250,000</option>
                        <option value="500000">500,000</option>
                        <option value="1000000">1,000,000</option>
                    </select>
                </div>
                <p><strong>Estimated Annual Dividend Income:</strong> <span id="calcEstimatedDividend">-</span></p>
            </div>
        </div>
    </div>

    <!-- Standard Calculator Modal -->
    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <button class="close-button calc-close-button" aria-label="Close calculator">&times;</button>
            <h2>Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input"></div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">รท</button>
                <button class="calc-btn operator" data-action="multiply">ร</button>
                <button class="calc-btn number" data-value="7">7</button>
                <button class="calc-btn number" data-value="8">8</button>
                <button class="calc-btn number" data-value="9">9</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                <button class="calc-btn number" data-value="4">4</button>
                <button class="calc-btn number" data-value="5">5</button>
                <button class="calc-btn number" data-value="6">6</button>
                <button class="calc-btn operator" data-action="add">+</button>
                <button class="calc-btn number" data-value="1">1</button>
                <button class="calc-btn number" data-value="2">2</button>
                <button class="calc-btn number" data-value="3">3</button>
                <button class="calc-btn equals" data-action="calculate">=</button>
                <button class="calc-btn number" data-value="0">0</button>
                <button class="calc-btn number" data-value=".">.</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal (for alerts/confirmations) -->
    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <h2 id="customDialogMessage" style="text-align: center;"></h2>
            <div class="custom-dialog-buttons" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                <button id="customDialogConfirmBtn" class="button">Confirm</button>
                <button id="customDialogCancelBtn" class="button secondary-buttons">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Watchlist Modal -->
    <div id="addWatchlistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2>Add New Watchlist</h2>
                <div class="modal-header-action-group">
                    <button id="saveWatchlistBtn" class="modal-action-icon" aria-label="Save watchlist">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="close-button" aria-label="Close add watchlist">&times;</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <label for="newWatchlistName">Watchlist Name:</label>
                <input type="text" id="newWatchlistName" placeholder="e.g., My Growth Stocks" required>
            </div>
        </div>
    </div>

    <!-- Manage Watchlist Modal -->
    <div id="manageWatchlistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2>Edit Watchlist</h2>
                <div class="modal-header-action-group">
                    <button id="saveWatchlistNameBtn" class="modal-action-icon" aria-label="Save watchlist name">
                        <i class="fas fa-save"></i>
                    </button>
                    <button id="deleteWatchlistInModalBtn" class="modal-action-icon danger" aria-label="Delete watchlist">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="close-button" aria-label="Close edit watchlist">&times;</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <label for="editWatchlistName">Watchlist Name:</label>
                <input type="text" id="editWatchlistName" required>
            </div>
        </div>
    </div>

    <!-- Custom Context Menu for Shares -->
    <div id="shareContextMenu" class="context-menu">
        <button id="contextEditShareBtn" class="context-menu-item"><i class="fas fa-edit"></i> Edit Share</button>
        <button id="contextDeleteShareBtn" class="context-menu-item danger-button"><i class="fas fa-trash-alt"></i> Delete Share</button>
    </div>

    <!-- NEW: Target Price Notification Icon (bottom right) -->
    <button id="targetHitIconBtn" class="target-hit-icon-btn" title="Shares at Target Price">
        <i class="fas fa-bell"></i>
        <span id="targetHitIconCount" class="target-hit-icon-count">0</span>
    </button>

    <!-- Alert Panel Container -->
    <div id="alertPanel" class="alert-panel">
        <div class="alert-panel-header">
            <h3>Notifications</h3>
            <button id="alertPanelCloseBtn" class="close-button">&times;</button>
        </div>
        <div id="alertList" class="alert-list">
            <!-- Alerts and reminders will be dynamically added here -->
            <p class="no-alerts-message">No active alerts or reminders.</p>
        </div>
        <div class="alert-panel-footer">
            <button id="dismissAllAlertsBtn" class="button secondary-buttons">Dismiss All</button>
        </div>
    </div>

    <!-- Scroll-to-Top Button -->
    <button id="scrollToTopBtn" title="Go to top"><i class="fas fa-arrow-up"></i></button>

    <!-- Firebase SDKs - Loaded as modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, FieldValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase configuration variables (provided by the environment)
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let firebaseInitialized = false;

        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseInitialized = true;
                // Attempt to sign in with custom token if available, otherwise anonymously
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then(() => console.log("Firebase: Signed in with custom token."))
                        .catch(error => {
                            console.error("Firebase: Custom token sign-in failed:", error);
                            signInAnonymously(auth)
                                .then(() => console.log("Firebase: Signed in anonymously after custom token failure."))
                                .catch(anonError => console.error("Firebase: Anonymous sign-in failed:", anonError));
                        });
                } else {
                    signInAnonymously(auth)
                        .then(() => console.log("Firebase: Signed in anonymously."))
                        .catch(error => console.error("Firebase: Anonymous sign-in failed:", error));
                }
                console.log("Firebase: Initialized successfully with config.");
            } else {
                console.warn("Firebase: No Firebase config found. Running in limited mode.");
                const errorDiv = document.getElementById('firebaseInitError');
                if (errorDiv) {
                    errorDiv.textContent = 'Firebase configuration missing. App functionality will be limited.';
                    errorDiv.style.display = 'block';
                }
            }
        } catch (e) {
            console.error("Firebase: Error during Firebase initialization:", e);
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.textContent = 'Error initializing Firebase: ' + e.message;
                errorDiv.style.display = 'block';
            }
            firebaseInitialized = false;
        }

        // Expose Firebase objects globally for script.js
        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete,
            writeBatch: writeBatch
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html script module loaded and DOMContentLoaded fired.");
        }); 
    </script>
    <!-- Linking to your separate script.js file -->
    <script src="script.js"></script>
</body>
</html>
